<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>산업 키워드 네트워크 - SmartQuery</title>
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Noto Sans KR', -apple-system, sans-serif; background: #0f172a; color: #e2e8f0; }

.layout { display: flex; height: 100vh; }

/* Sidebar */
.sidebar {
    width: 340px; min-width: 340px;
    background: #1e293b; border-right: 1px solid #334155;
    display: flex; flex-direction: column; overflow: hidden;
}
.sidebar-header {
    padding: 1.2rem; border-bottom: 1px solid #334155;
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
}
.sidebar-header h1 { font-size: 1.1rem; color: #f59e0b; margin-bottom: 0.3rem; }
.sidebar-header p { font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem; }
.sidebar-header .meta { font-size: 0.7rem; color: #64748b; }
.top-nav {
    position: absolute; top: 12px; right: 16px; z-index: 20;
    display: flex; gap: 0.35rem; flex-wrap: wrap;
}
.top-nav a {
    padding: 0.3rem 0.6rem; color: #fff; text-decoration: none;
    border-radius: 6px; font-size: 0.75rem; font-weight: 600;
}

.controls { padding: 1rem; border-bottom: 1px solid #334155; }
.control-group { margin-bottom: 0.8rem; }
.control-group label { font-size: 0.75rem; color: #94a3b8; display: block; margin-bottom: 0.3rem; }
.control-group select, .control-group input {
    width: 100%; padding: 0.4rem 0.6rem; background: #0f172a; border: 1px solid #475569;
    border-radius: 6px; color: #e2e8f0; font-size: 0.8rem;
}
.slider-row { display: flex; align-items: center; gap: 0.5rem; }
.slider-row input[type=range] { flex: 1; }
.slider-row span { font-size: 0.75rem; color: #f59e0b; min-width: 24px; }

.legend { padding: 0.8rem 1rem; border-bottom: 1px solid #334155; }
.legend h3 { font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem; }
.legend-item { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.3rem; font-size: 0.72rem; }
.legend-dot { width: 10px; height: 10px; border-radius: 50%; }

/* Detail panel */
.detail-panel {
    flex: 1; overflow-y: auto; padding: 1rem;
    scrollbar-width: thin; scrollbar-color: #475569 #1e293b;
}
.detail-title { font-size: 0.9rem; color: #f59e0b; margin-bottom: 0.5rem; }
.detail-subtitle { font-size: 0.7rem; color: #94a3b8; margin-bottom: 0.8rem; }
.kw-tag {
    display: inline-block; padding: 0.2rem 0.5rem; margin: 0.15rem;
    border-radius: 4px; font-size: 0.7rem; background: #1e293b; border: 1px solid #334155;
}
.kw-tag.driver { border-color: #f59e0b; color: #fbbf24; }
.kw-tag.supply { border-color: #10b981; color: #34d399; }
.kw-tag.tech { border-color: #8b5cf6; color: #a78bfa; }
.kw-tag.policy { border-color: #ef4444; color: #f87171; }
.connection-item {
    padding: 0.5rem; margin-bottom: 0.4rem; background: #0f172a;
    border-radius: 6px; border: 1px solid #334155; cursor: pointer;
}
.connection-item:hover { border-color: #f59e0b; }
.conn-header { display: flex; justify-content: space-between; align-items: center; }
.conn-name { font-size: 0.8rem; color: #f1f5f9; }
.conn-count { font-size: 0.7rem; color: #f59e0b; font-weight: 600; }
.conn-keywords { font-size: 0.65rem; color: #64748b; margin-top: 0.3rem; }

/* Main graph area */
.graph-area { flex: 1; position: relative; }
#network { width: 100%; height: 100%; background: #0f172a; }

/* Stats bar */
.stats-bar {
    position: absolute; top: 12px; left: 12px;
    display: flex; gap: 0.5rem; z-index: 10; pointer-events: none;
}
.stat-chip {
    padding: 0.3rem 0.7rem; background: rgba(30,41,59,0.9);
    border: 1px solid #334155; border-radius: 6px;
    font-size: 0.7rem; color: #94a3b8; backdrop-filter: blur(8px);
}
.stat-chip b { color: #f59e0b; }

/* View toggle */
.view-toggle {
    position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%);
    display: flex; gap: 0; z-index: 10; border-radius: 8px; overflow: hidden;
    border: 1px solid #334155;
}
.view-btn {
    padding: 0.5rem 1rem; background: #1e293b; color: #94a3b8;
    border: none; cursor: pointer; font-size: 0.75rem; transition: all 0.2s;
}
.view-btn.active { background: #f59e0b; color: #fff; }
.view-btn:hover:not(.active) { background: #334155; }

/* Preset buttons */
.preset-group { display: flex; gap: 0.4rem; margin-bottom: 0.8rem; }
.preset-btn {
    flex: 1; padding: 0.5rem 0.4rem; border: 1px solid #475569;
    border-radius: 6px; background: #0f172a; color: #94a3b8;
    font-size: 0.75rem; cursor: pointer; text-align: center;
    transition: all 0.2s; font-weight: 500;
}
.preset-btn:hover { border-color: #f59e0b; color: #e2e8f0; }
.preset-btn.active { background: #f59e0b; border-color: #f59e0b; color: #fff; font-weight: 600; }

@media (prefers-reduced-motion: reduce) {
    * { transition: none !important; animation: none !important; }
}
</style>
</head>
<body>
<div class="layout">
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>산업 키워드 연결 네트워크</h1>
            <p>Industry Keyword Relationship Graph</p>
            <div class="meta" id="metaInfo">Loading...</div>
        </div>
        <div class="controls">
            <div class="control-group">
                <label>그래프 복잡도</label>
                <div class="preset-group">
                    <button class="preset-btn" onclick="setPreset('simple')" id="preset-simple">핵심만</button>
                    <button class="preset-btn active" onclick="setPreset('standard')" id="preset-standard">보통</button>
                    <button class="preset-btn" onclick="setPreset('detailed')" id="preset-detailed">상세</button>
                </div>
            </div>
            <div class="control-group">
                <label>Min Shared Keywords: <span id="threshLabel">25</span></label>
                <div class="slider-row">
                    <input type="range" id="threshold" min="3" max="80" value="25" oninput="updateThreshold()">
                </div>
            </div>
            <div class="control-group">
                <label>Category Filter</label>
                <select id="catFilter" onchange="applyFilters()">
                    <option value="">-- All Categories --</option>
                </select>
            </div>
            <div class="control-group">
                <label>Focus Industry</label>
                <select id="focusIndustry" onchange="applyFilters()">
                    <option value="">-- All Industries --</option>
                </select>
            </div>
            <div class="control-group">
                <label>View Mode</label>
                <select id="viewMode" onchange="switchView()">
                    <option value="industry">Industry Network (산업 연결)</option>
                    <option value="keyword">Bridge Keywords (키워드 허브)</option>
                </select>
            </div>
        </div>
        <div class="legend" id="legendPanel">
            <h3>AlphaVantage-style Categories</h3>
        </div>
        <div class="detail-panel" id="detailPanel">
            <div class="detail-title">Click a node to see details</div>
            <div class="detail-subtitle">노드를 클릭하면 연결 정보를 볼 수 있습니다</div>
        </div>
    </div>
    <div class="graph-area">
        <div class="stats-bar" id="statsBar">
            <div class="stat-chip">Nodes: <b id="statNodes">0</b></div>
            <div class="stat-chip">Edges: <b id="statEdges">0</b></div>
            <div class="stat-chip">Threshold: <b id="statThresh">25</b></div>
        </div>
        <div class="top-nav">
            <a href="/analysis" style="background: linear-gradient(135deg, #10b981, #3b82f6);">종목분석</a>
            <a href="/industry" style="background: linear-gradient(135deg, #f59e0b, #8b5cf6);">산업분석</a>
            <a href="/strategy" style="background: linear-gradient(135deg, #8b5cf6, #06b6d4);">투자전략</a>
            <a href="/economy" style="background: linear-gradient(135deg, #06b6d4, #3b82f6);">경제분석</a>
            <a href="https://stock-chart-tau.vercel.app/" target="_blank" style="background: linear-gradient(135deg, #3b82f6, #8b5cf6);">KRX차트</a>
        </div>
        <div id="network"></div>
    </div>
</div>

<script>
let graphData = null;
let network = null;
let currentView = 'industry';

// Category colors (from data, with fallback)
let CAT_COLORS = {};

const REL_COLORS = {
    DRIVEN_BY: '#f59e0b',
    SUPPLIED_BY: '#10b981',
    ENABLED_BY: '#8b5cf6',
    SHAPED_BY: '#ef4444',
    CATALYZED_BY: '#06b6d4',
};

function getNodeColor(ind) {
    if (ind && ind.color) return ind.color;
    return '#64748b';
}

async function loadData() {
    const resp = await fetch('/industry/keyword-graph-data');
    graphData = await resp.json();

    // Build category color map and legend
    if (graphData.categories) {
        const legend = document.getElementById('legendPanel');
        let html = '<h3>AlphaVantage-style Categories</h3>';
        Object.entries(graphData.categories).forEach(([name, info]) => {
            CAT_COLORS[name] = info.color;
            html += `<div class="legend-item"><div class="legend-dot" style="background:${info.color}"></div> ${name} (${info.count})</div>`;
        });
        legend.innerHTML = html;
    }

    // Meta info
    if (graphData.meta) {
        document.getElementById('metaInfo').textContent =
            `${graphData.meta.total_industries} industries | ${graphData.meta.total_edges} edges | ${graphData.meta.category_count} categories`;
    }

    populateFilters();
    renderIndustryNetwork();
}

function populateFilters() {
    // Category filter
    const catSel = document.getElementById('catFilter');
    if (graphData.categories) {
        Object.entries(graphData.categories).forEach(([name, info]) => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = `${name} (${info.count})`;
            catSel.appendChild(opt);
        });
    }
    // Industry filter
    const sel = document.getElementById('focusIndustry');
    const sorted = [...graphData.industries].sort((a, b) => b.kw_count - a.kw_count);
    sorted.forEach(ind => {
        const opt = document.createElement('option');
        opt.value = ind.name;
        opt.textContent = `${ind.name} (${ind.kw_count} kw)`;
        sel.appendChild(opt);
    });
}

function renderIndustryNetwork() {
    const threshold = parseInt(document.getElementById('threshold').value);
    const focus = document.getElementById('focusIndustry').value;
    const catFilter = document.getElementById('catFilter').value;

    let edges = graphData.edges.filter(e => e.shared >= threshold);

    // Category filter
    if (catFilter) {
        const catInds = new Set(graphData.industries.filter(i => i.category === catFilter).map(i => i.name));
        edges = edges.filter(e => catInds.has(e.ind1) || catInds.has(e.ind2));
    }

    if (focus) {
        edges = edges.filter(e => e.ind1 === focus || e.ind2 === focus);
    }

    // Collect visible industries
    const visibleInds = new Set();
    edges.forEach(e => { visibleInds.add(e.ind1); visibleInds.add(e.ind2); });

    const indMap = {};
    graphData.industries.forEach(ind => { indMap[ind.name] = ind; });

    // Build nodes with category colors
    const nodes = [];
    visibleInds.forEach(name => {
        const ind = indMap[name] || { name, kw_count: 0, total_rels: 0, category: 'Other', color: '#64748b' };
        const size = Math.max(15, Math.min(60, 10 + ind.kw_count * 0.3));
        const col = ind.color || '#64748b';
        nodes.push({
            id: name,
            label: name,
            size: size,
            color: {
                background: col,
                border: col,
                highlight: { background: '#f1f5f9', border: '#f59e0b' },
            },
            font: { color: '#e2e8f0', size: Math.max(10, Math.min(16, 8 + ind.kw_count * 0.08)), face: 'Noto Sans KR' },
            title: `${name}\n[${ind.category}]\nKeywords: ${ind.kw_count}\nRelationships: ${ind.total_rels}`,
            kwCount: ind.kw_count,
        });
    });

    // Build edges
    const maxShared = edges.length > 0 ? Math.max(...edges.map(e => e.shared)) : 1;
    const visEdges = edges.map((e, i) => ({
        id: `e${i}`,
        from: e.ind1,
        to: e.ind2,
        value: e.shared,
        title: `${e.ind1} ↔ ${e.ind2}\n${e.shared} shared keywords\n${e.keywords.join(', ')}`,
        color: { color: `rgba(245, 158, 11, ${0.15 + 0.6 * (e.shared / maxShared)})`, highlight: '#f59e0b' },
        width: Math.max(1, Math.min(8, e.shared / 10)),
        _data: e,
    }));

    drawNetwork(nodes, visEdges);
    updateStats(nodes.length, visEdges.length, threshold);
}

function renderKeywordNetwork() {
    const focus = document.getElementById('focusIndustry').value;
    const catFilter = document.getElementById('catFilter').value;

    let keywords = graphData.bridge_keywords;

    const indMap = {};
    graphData.industries.forEach(ind => { indMap[ind.name] = ind; });

    const nodes = [];
    const visEdges = [];
    const indNodes = new Set();

    keywords.forEach(kw => {
        let industries = kw.industries;
        if (focus && !industries.includes(focus)) return;
        if (catFilter) {
            industries = industries.filter(ind => {
                const info = indMap[ind];
                return info && info.category === catFilter;
            });
            if (industries.length === 0) return;
        }

        const size = Math.max(12, Math.min(50, 5 + kw.ind_count * 1.5));
        nodes.push({
            id: `kw:${kw.keyword}`,
            label: kw.keyword,
            size: size,
            color: { background: '#8b5cf6', border: '#a78bfa', highlight: { background: '#c4b5fd', border: '#8b5cf6' } },
            font: { color: '#e2e8f0', size: Math.max(9, Math.min(14, 7 + kw.ind_count * 0.3)) },
            shape: 'diamond',
            title: `${kw.keyword}\nType: ${kw.ktype}\nIndustries: ${kw.ind_count}`,
        });

        industries.forEach(ind => {
            indNodes.add(ind);
            const relType = kw.rel_types[0] || 'DRIVEN_BY';
            visEdges.push({
                from: ind,
                to: `kw:${kw.keyword}`,
                color: { color: REL_COLORS[relType] || '#475569', highlight: '#f1f5f9' },
                width: 1.5,
                arrows: { to: { scaleFactor: 0.5 } },
            });
        });
    });

    // Add industry nodes with category colors
    indNodes.forEach(name => {
        const ind = indMap[name] || { name, kw_count: 0, color: '#64748b', category: 'Other' };
        const col = ind.color || '#64748b';
        nodes.push({
            id: name,
            label: name,
            size: Math.max(15, Math.min(45, 10 + ind.kw_count * 0.25)),
            color: { background: col, border: col, highlight: { background: '#f1f5f9', border: '#f59e0b' } },
            font: { color: '#e2e8f0', size: 11 },
            shape: 'dot',
            title: `${name}\n[${ind.category}]\nKeywords: ${ind.kw_count}`,
        });
    });

    drawNetwork(nodes, visEdges);
    updateStats(nodes.length, visEdges.length, '-');
}

function drawNetwork(nodes, edges) {
    const container = document.getElementById('network');
    const data = {
        nodes: new vis.DataSet(nodes),
        edges: new vis.DataSet(edges),
    };

    const options = {
        physics: {
            solver: 'forceAtlas2Based',
            forceAtlas2Based: {
                gravitationalConstant: -80,
                centralGravity: 0.01,
                springLength: 150,
                springConstant: 0.02,
                damping: 0.5,
            },
            stabilization: { iterations: 200, fit: true },
        },
        interaction: { hover: true, tooltipDelay: 100, zoomView: true, dragView: true },
        nodes: { borderWidth: 2, shadow: { enabled: true, color: 'rgba(0,0,0,0.3)', size: 5 } },
        edges: { smooth: { type: 'continuous' } },
    };

    network = new vis.Network(container, data, options);

    network.on('click', function(params) {
        if (params.nodes.length > 0) showDetail(params.nodes[0]);
    });
    network.on('hoverNode', () => { container.style.cursor = 'pointer'; });
    network.on('blurNode', () => { container.style.cursor = 'default'; });
}

function showDetail(nodeId) {
    const panel = document.getElementById('detailPanel');
    const indMap = {};
    graphData.industries.forEach(ind => { indMap[ind.name] = ind; });

    if (nodeId.startsWith('kw:')) {
        const kwName = nodeId.replace('kw:', '');
        const kw = graphData.bridge_keywords.find(k => k.keyword === kwName);
        if (!kw) return;
        panel.innerHTML = `
            <div class="detail-title">${kwName}</div>
            <div class="detail-subtitle">Type: ${kw.ktype} | ${kw.ind_count} industries</div>
            <div class="detail-subtitle">Relationship types: ${kw.rel_types.join(', ')}</div>
            <h4 style="font-size:0.75rem;color:#94a3b8;margin:0.5rem 0 0.3rem">Connected Industries:</h4>
            ${kw.industries.slice(0, 20).map(ind => {
                const info = indMap[ind];
                const col = info ? info.color : '#64748b';
                const cat = info ? info.category : '';
                return `<div class="connection-item" onclick="focusNode('${ind}')">
                    <div class="conn-header">
                        <span class="conn-name"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${col};margin-right:4px;"></span>${ind}</span>
                        <span style="font-size:0.65rem;color:#64748b;">${cat}</span>
                    </div>
                </div>`;
            }).join('')}
        `;
    } else {
        const ind = indMap[nodeId] || {};
        const details = graphData.industry_details[nodeId] || [];
        const connections = graphData.edges
            .filter(e => e.ind1 === nodeId || e.ind2 === nodeId)
            .sort((a, b) => b.shared - a.shared);

        const catColor = ind.color || '#64748b';
        const catName = ind.category || 'Other';

        panel.innerHTML = `
            <div class="detail-title">${nodeId}</div>
            <div class="detail-subtitle">
                <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${catColor};margin-right:4px;"></span>
                ${catName} | Keywords: ${ind.kw_count || '?'} | Rel types: ${(ind.rel_types || []).join(', ')}
            </div>

            <h4 style="font-size:0.75rem;color:#94a3b8;margin:0.8rem 0 0.3rem">Top Keywords:</h4>
            <div>${details.map(d => {
                const cls = d.rel === 'DRIVEN_BY' ? 'driver' : d.rel === 'SUPPLIED_BY' ? 'supply' : d.rel === 'ENABLED_BY' ? 'tech' : d.rel === 'SHAPED_BY' ? 'policy' : '';
                return `<span class="kw-tag ${cls}">${d.kw} (${d.bridges})</span>`;
            }).join('')}</div>

            <h4 style="font-size:0.75rem;color:#94a3b8;margin:0.8rem 0 0.3rem">Connected Industries (${connections.length}):</h4>
            ${connections.slice(0, 15).map(e => {
                const other = e.ind1 === nodeId ? e.ind2 : e.ind1;
                const otherInfo = indMap[other] || {};
                const otherCol = otherInfo.color || '#64748b';
                return `
                    <div class="connection-item" onclick="focusNode('${other}')">
                        <div class="conn-header">
                            <span class="conn-name"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${otherCol};margin-right:4px;"></span>${other}</span>
                            <span class="conn-count">${e.shared} kw</span>
                        </div>
                        <div class="conn-keywords">${e.keywords.join(', ')}</div>
                    </div>
                `;
            }).join('')}
        `;
    }
}

function focusNode(nodeId) {
    if (network) {
        network.focus(nodeId, { scale: 1.5, animation: true });
        network.selectNodes([nodeId]);
        showDetail(nodeId);
    }
}

function switchView() {
    currentView = document.getElementById('viewMode').value;
    applyFilters();
}

const PRESETS = { simple: 45, standard: 25, detailed: 8 };

function setPreset(level) {
    const val = PRESETS[level];
    document.getElementById('threshold').value = val;
    document.getElementById('threshLabel').textContent = val;
    ['simple', 'standard', 'detailed'].forEach(p => {
        document.getElementById('preset-' + p).classList.toggle('active', p === level);
    });
    applyFilters();
}

function updateThreshold() {
    const val = parseInt(document.getElementById('threshold').value);
    document.getElementById('threshLabel').textContent = val;
    ['simple', 'standard', 'detailed'].forEach(p => {
        document.getElementById('preset-' + p).classList.toggle('active', val === PRESETS[p]);
    });
    if (currentView === 'industry') renderIndustryNetwork();
}

function applyFilters() {
    if (currentView === 'industry') renderIndustryNetwork();
    else renderKeywordNetwork();
}

function updateStats(nodes, edges, thresh) {
    document.getElementById('statNodes').textContent = nodes;
    document.getElementById('statEdges').textContent = edges;
    document.getElementById('statThresh').textContent = thresh;
}

loadData();
</script>
</body>
</html>
