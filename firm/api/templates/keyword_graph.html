<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>산업 키워드 네트워크 - SmartQuery</title>
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Noto Sans KR', -apple-system, sans-serif; background: #0f172a; color: #e2e8f0; }

.layout { display: flex; height: 100vh; }

/* Sidebar */
.sidebar {
    width: 340px; min-width: 340px;
    background: #1e293b; border-right: 1px solid #334155;
    display: flex; flex-direction: column; overflow: hidden;
}
.sidebar-header {
    padding: 1.2rem; border-bottom: 1px solid #334155;
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
}
.sidebar-header h1 { font-size: 1.1rem; color: #f1f5f9; margin-bottom: 0.3rem; }
.sidebar-header p { font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem; }
.top-nav {
    position: absolute; top: 12px; right: 16px; z-index: 20;
    display: flex; gap: 0.5rem;
}
.top-nav-link {
    display: inline-flex; align-items: center; gap: 0.4rem;
    padding: 0.55rem 1.1rem; text-decoration: none; border-radius: 8px;
    font-size: 0.82rem; font-weight: 600; letter-spacing: 0.01em;
    transition: all 0.2s; backdrop-filter: blur(10px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.top-nav-link.theme-link {
    background: rgba(59,130,246,0.25); color: #93c5fd;
    border: 1px solid rgba(59,130,246,0.5);
}
.top-nav-link.theme-link:hover {
    background: rgba(59,130,246,0.45); color: #fff;
    border-color: rgba(96,165,250,0.8); box-shadow: 0 2px 16px rgba(59,130,246,0.3);
}
.top-nav-link.industry-link {
    background: rgba(16,185,129,0.2); color: #6ee7b7;
    border: 1px solid rgba(16,185,129,0.45);
}
.top-nav-link.industry-link:hover {
    background: rgba(16,185,129,0.4); color: #fff;
    border-color: rgba(52,211,153,0.8); box-shadow: 0 2px 16px rgba(16,185,129,0.3);
}

.controls { padding: 1rem; border-bottom: 1px solid #334155; }
.control-group { margin-bottom: 0.8rem; }
.control-group label { font-size: 0.75rem; color: #94a3b8; display: block; margin-bottom: 0.3rem; }
.control-group select, .control-group input {
    width: 100%; padding: 0.4rem 0.6rem; background: #0f172a; border: 1px solid #475569;
    border-radius: 6px; color: #e2e8f0; font-size: 0.8rem;
}
.slider-row { display: flex; align-items: center; gap: 0.5rem; }
.slider-row input[type=range] { flex: 1; }
.slider-row span { font-size: 0.75rem; color: #60a5fa; min-width: 24px; }

.legend { padding: 0.8rem 1rem; border-bottom: 1px solid #334155; }
.legend h3 { font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem; }
.legend-item { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.3rem; font-size: 0.75rem; }
.legend-dot { width: 10px; height: 10px; border-radius: 50%; }
.legend-line { width: 20px; height: 3px; border-radius: 2px; }

/* Detail panel */
.detail-panel {
    flex: 1; overflow-y: auto; padding: 1rem;
    scrollbar-width: thin; scrollbar-color: #475569 #1e293b;
}
.detail-title { font-size: 0.9rem; color: #60a5fa; margin-bottom: 0.5rem; }
.detail-subtitle { font-size: 0.7rem; color: #94a3b8; margin-bottom: 0.8rem; }
.kw-tag {
    display: inline-block; padding: 0.2rem 0.5rem; margin: 0.15rem;
    border-radius: 4px; font-size: 0.7rem; background: #1e293b; border: 1px solid #334155;
}
.kw-tag.driver { border-color: #f59e0b; color: #fbbf24; }
.kw-tag.supply { border-color: #10b981; color: #34d399; }
.kw-tag.tech { border-color: #8b5cf6; color: #a78bfa; }
.kw-tag.policy { border-color: #ef4444; color: #f87171; }
.connection-item {
    padding: 0.5rem; margin-bottom: 0.4rem; background: #0f172a;
    border-radius: 6px; border: 1px solid #334155; cursor: pointer;
}
.connection-item:hover { border-color: #60a5fa; }
.conn-header { display: flex; justify-content: space-between; align-items: center; }
.conn-name { font-size: 0.8rem; color: #f1f5f9; }
.conn-count { font-size: 0.7rem; color: #60a5fa; font-weight: 600; }
.conn-keywords { font-size: 0.65rem; color: #64748b; margin-top: 0.3rem; }

/* Main graph area */
.graph-area { flex: 1; position: relative; }
#network { width: 100%; height: 100%; background: #0f172a; }

/* Stats bar */
.stats-bar {
    position: absolute; top: 12px; left: 12px; right: 12px;
    display: flex; gap: 0.5rem; z-index: 10; pointer-events: none;
}
.stat-chip {
    padding: 0.3rem 0.7rem; background: rgba(30,41,59,0.9);
    border: 1px solid #334155; border-radius: 6px;
    font-size: 0.7rem; color: #94a3b8; backdrop-filter: blur(8px);
}
.stat-chip b { color: #60a5fa; }

/* View toggle */
.view-toggle {
    position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%);
    display: flex; gap: 0; z-index: 10; border-radius: 8px; overflow: hidden;
    border: 1px solid #334155;
}
.view-btn {
    padding: 0.5rem 1rem; background: #1e293b; color: #94a3b8;
    border: none; cursor: pointer; font-size: 0.75rem; transition: all 0.2s;
}
.view-btn.active { background: #3b82f6; color: #fff; }
.view-btn:hover:not(.active) { background: #334155; }

/* Tooltip */
.graph-tooltip {
    position: absolute; display: none; padding: 0.6rem 0.8rem;
    background: rgba(15,23,42,0.95); border: 1px solid #475569;
    border-radius: 8px; font-size: 0.75rem; max-width: 300px;
    z-index: 100; backdrop-filter: blur(8px); pointer-events: none;
}

@media (prefers-reduced-motion: reduce) {
    * { transition: none !important; animation: none !important; }
}
</style>
</head>
<body>
<div class="layout">
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>산업 키워드 연결 네트워크</h1>
            <p>Industry Keyword Relationship Graph</p>
        </div>
        <div class="controls">
            <div class="control-group">
                <label>View Mode</label>
                <select id="viewMode" onchange="switchView()">
                    <option value="industry">Industry Network (산업 연결)</option>
                    <option value="keyword">Bridge Keywords (키워드 허브)</option>
                </select>
            </div>
            <div class="control-group">
                <label>Min Shared Keywords: <span id="threshLabel">25</span></label>
                <div class="slider-row">
                    <input type="range" id="threshold" min="3" max="80" value="25" oninput="updateThreshold()">
                </div>
            </div>
            <div class="control-group">
                <label>Focus Industry</label>
                <select id="focusIndustry" onchange="focusOnIndustry()">
                    <option value="">-- All Industries --</option>
                </select>
            </div>
            <div class="control-group">
                <label>Keyword Type Filter</label>
                <select id="kwTypeFilter" onchange="applyFilters()">
                    <option value="all">All Types</option>
                    <option value="DRIVER">DRIVER (동인)</option>
                    <option value="SUPPLY_CHAIN">SUPPLY CHAIN (공급망)</option>
                    <option value="TECH">TECH (기술)</option>
                    <option value="POLICY">POLICY (정책)</option>
                </select>
            </div>
        </div>
        <div class="legend">
            <h3>Node Size = Keyword Connections</h3>
            <div class="legend-item"><div class="legend-line" style="background:#f59e0b"></div> DRIVEN_BY (동인/수요)</div>
            <div class="legend-item"><div class="legend-line" style="background:#10b981"></div> SUPPLIED_BY (공급망)</div>
            <div class="legend-item"><div class="legend-line" style="background:#8b5cf6"></div> ENABLED_BY (기술)</div>
            <div class="legend-item"><div class="legend-line" style="background:#ef4444"></div> SHAPED_BY (정책)</div>
        </div>
        <div class="detail-panel" id="detailPanel">
            <div class="detail-title">Click a node to see details</div>
            <div class="detail-subtitle">노드를 클릭하면 연결 정보를 볼 수 있습니다</div>
        </div>
    </div>
    <div class="graph-area">
        <div class="stats-bar" id="statsBar">
            <div class="stat-chip">Nodes: <b id="statNodes">0</b></div>
            <div class="stat-chip">Edges: <b id="statEdges">0</b></div>
            <div class="stat-chip">Threshold: <b id="statThresh">10</b></div>
        </div>
        <div class="top-nav">
            <a href="https://web-production-e5d7.up.railway.app/theme-graph.html" target="_blank" class="top-nav-link theme-link">종목/테마 네트워크 &rarr;</a>
            <a href="/industry" class="top-nav-link industry-link">산업분석 &rarr;</a>
        </div>
        <div id="network"></div>
        <div class="graph-tooltip" id="tooltip"></div>
    </div>
</div>

<script>
let graphData = null;
let network = null;
let currentView = 'industry';

// Color palette for industries (by size group)
const COLORS = {
    large: '#3b82f6',   // blue - many connections
    medium: '#10b981',  // green
    small: '#f59e0b',   // amber
    tiny: '#64748b',    // gray
    keyword: '#8b5cf6', // purple for keyword nodes
};

const REL_COLORS = {
    DRIVEN_BY: '#f59e0b',
    SUPPLIED_BY: '#10b981',
    ENABLED_BY: '#8b5cf6',
    SHAPED_BY: '#ef4444',
    CATALYZED_BY: '#06b6d4',
};

async function loadData() {
    const resp = await fetch('/industry/keyword-graph-data');
    graphData = await resp.json();
    populateFilters();
    renderIndustryNetwork();
}

function populateFilters() {
    const sel = document.getElementById('focusIndustry');
    const sorted = [...graphData.industries].sort((a, b) => b.kw_count - a.kw_count);
    sorted.forEach(ind => {
        const opt = document.createElement('option');
        opt.value = ind.name;
        opt.textContent = `${ind.name} (${ind.kw_count} kw)`;
        sel.appendChild(opt);
    });
}

function getNodeColor(kwCount) {
    if (kwCount >= 80) return COLORS.large;
    if (kwCount >= 30) return COLORS.medium;
    if (kwCount >= 10) return COLORS.small;
    return COLORS.tiny;
}

function renderIndustryNetwork() {
    const threshold = parseInt(document.getElementById('threshold').value);
    const focus = document.getElementById('focusIndustry').value;

    let edges = graphData.edges.filter(e => e.shared >= threshold);

    if (focus) {
        edges = edges.filter(e => e.ind1 === focus || e.ind2 === focus);
    }

    // Collect visible industries
    const visibleInds = new Set();
    edges.forEach(e => { visibleInds.add(e.ind1); visibleInds.add(e.ind2); });

    const indMap = {};
    graphData.industries.forEach(ind => { indMap[ind.name] = ind; });

    // Build nodes
    const nodes = [];
    visibleInds.forEach(name => {
        const ind = indMap[name] || { name, kw_count: 0, total_rels: 0 };
        const size = Math.max(15, Math.min(60, 10 + ind.kw_count * 0.3));
        nodes.push({
            id: name,
            label: name,
            size: size,
            color: {
                background: getNodeColor(ind.kw_count),
                border: getNodeColor(ind.kw_count),
                highlight: { background: '#f1f5f9', border: '#3b82f6' },
            },
            font: { color: '#e2e8f0', size: Math.max(10, Math.min(16, 8 + ind.kw_count * 0.08)) },
            title: `${name}\nKeywords: ${ind.kw_count}\nRelationships: ${ind.total_rels}`,
            kwCount: ind.kw_count,
        });
    });

    // Build edges
    const maxShared = Math.max(...edges.map(e => e.shared));
    const visEdges = edges.map((e, i) => ({
        id: `e${i}`,
        from: e.ind1,
        to: e.ind2,
        value: e.shared,
        title: `${e.ind1} ↔ ${e.ind2}\n${e.shared} shared keywords\n${e.keywords.join(', ')}`,
        color: { color: `rgba(96, 165, 250, ${0.2 + 0.6 * (e.shared / maxShared)})`, highlight: '#60a5fa' },
        width: Math.max(1, Math.min(8, e.shared / 10)),
        _data: e,
    }));

    drawNetwork(nodes, visEdges);
    updateStats(nodes.length, visEdges.length, threshold);
}

function renderKeywordNetwork() {
    const typeFilter = document.getElementById('kwTypeFilter').value;
    const focus = document.getElementById('focusIndustry').value;

    let keywords = graphData.bridge_keywords;
    if (typeFilter !== 'all') {
        keywords = keywords.filter(k => k.rel_types.some(r => {
            if (typeFilter === 'DRIVER') return r === 'DRIVEN_BY';
            if (typeFilter === 'SUPPLY_CHAIN') return r === 'SUPPLIED_BY';
            if (typeFilter === 'TECH') return r === 'ENABLED_BY';
            if (typeFilter === 'POLICY') return r === 'SHAPED_BY';
            return false;
        }));
    }

    const nodes = [];
    const visEdges = [];
    const indNodes = new Set();

    keywords.forEach(kw => {
        let industries = kw.industries;
        if (focus) {
            if (!industries.includes(focus)) return;
        }
        // Add keyword node
        const size = Math.max(12, Math.min(50, 5 + kw.ind_count * 1.5));
        nodes.push({
            id: `kw:${kw.keyword}`,
            label: kw.keyword,
            size: size,
            color: { background: '#8b5cf6', border: '#a78bfa', highlight: { background: '#c4b5fd', border: '#8b5cf6' } },
            font: { color: '#e2e8f0', size: Math.max(9, Math.min(14, 7 + kw.ind_count * 0.3)) },
            shape: 'diamond',
            title: `${kw.keyword}\nType: ${kw.ktype}\nIndustries: ${kw.ind_count}`,
        });

        // Add industry connections
        industries.forEach(ind => {
            if (focus && ind !== focus && kw.keyword !== focus) {
                // In focus mode, show all connected industries
            }
            indNodes.add(ind);
            const relType = kw.rel_types[0] || 'DRIVEN_BY';
            visEdges.push({
                from: ind,
                to: `kw:${kw.keyword}`,
                color: { color: REL_COLORS[relType] || '#475569', highlight: '#f1f5f9' },
                width: 1.5,
                arrows: { to: { scaleFactor: 0.5 } },
            });
        });
    });

    // Add industry nodes
    const indMap = {};
    graphData.industries.forEach(ind => { indMap[ind.name] = ind; });
    indNodes.forEach(name => {
        const ind = indMap[name] || { name, kw_count: 0 };
        nodes.push({
            id: name,
            label: name,
            size: Math.max(15, Math.min(45, 10 + ind.kw_count * 0.25)),
            color: { background: getNodeColor(ind.kw_count), border: getNodeColor(ind.kw_count) },
            font: { color: '#e2e8f0', size: 11 },
            shape: 'dot',
        });
    });

    drawNetwork(nodes, visEdges);
    updateStats(nodes.length, visEdges.length, '-');
}

function drawNetwork(nodes, edges) {
    const container = document.getElementById('network');
    const data = {
        nodes: new vis.DataSet(nodes),
        edges: new vis.DataSet(edges),
    };

    const options = {
        physics: {
            solver: 'forceAtlas2Based',
            forceAtlas2Based: {
                gravitationalConstant: -80,
                centralGravity: 0.01,
                springLength: 150,
                springConstant: 0.02,
                damping: 0.5,
            },
            stabilization: { iterations: 200, fit: true },
        },
        interaction: {
            hover: true,
            tooltipDelay: 100,
            zoomView: true,
            dragView: true,
        },
        nodes: {
            borderWidth: 2,
            shadow: { enabled: true, color: 'rgba(0,0,0,0.3)', size: 5 },
        },
        edges: {
            smooth: { type: 'continuous' },
        },
    };

    network = new vis.Network(container, data, options);

    network.on('click', function(params) {
        if (params.nodes.length > 0) {
            showDetail(params.nodes[0]);
        }
    });

    network.on('hoverNode', function(params) {
        container.style.cursor = 'pointer';
    });
    network.on('blurNode', function() {
        container.style.cursor = 'default';
    });
}

function showDetail(nodeId) {
    const panel = document.getElementById('detailPanel');

    if (nodeId.startsWith('kw:')) {
        // Keyword node detail
        const kwName = nodeId.replace('kw:', '');
        const kw = graphData.bridge_keywords.find(k => k.keyword === kwName);
        if (!kw) return;
        panel.innerHTML = `
            <div class="detail-title">${kwName}</div>
            <div class="detail-subtitle">Type: ${kw.ktype} | ${kw.ind_count} industries</div>
            <div class="detail-subtitle">Relationship types: ${kw.rel_types.join(', ')}</div>
            <h4 style="font-size:0.75rem;color:#94a3b8;margin:0.5rem 0 0.3rem">Connected Industries:</h4>
            ${kw.industries.map(ind => `
                <div class="connection-item" onclick="focusNode('${ind}')">
                    <div class="conn-name">${ind}</div>
                </div>
            `).join('')}
        `;
    } else {
        // Industry node detail
        const ind = graphData.industries.find(i => i.name === nodeId);
        const details = graphData.industry_details[nodeId] || [];
        const connections = graphData.edges
            .filter(e => e.ind1 === nodeId || e.ind2 === nodeId)
            .sort((a, b) => b.shared - a.shared);

        panel.innerHTML = `
            <div class="detail-title">${nodeId}</div>
            <div class="detail-subtitle">Keywords: ${ind ? ind.kw_count : '?'} | Rel types: ${ind ? ind.rel_types.join(', ') : ''}</div>

            <h4 style="font-size:0.75rem;color:#94a3b8;margin:0.8rem 0 0.3rem">Top Keywords:</h4>
            <div>${details.map(d => {
                const cls = d.rel === 'DRIVEN_BY' ? 'driver' : d.rel === 'SUPPLIED_BY' ? 'supply' : d.rel === 'ENABLED_BY' ? 'tech' : d.rel === 'SHAPED_BY' ? 'policy' : '';
                return `<span class="kw-tag ${cls}">${d.kw} (${d.bridges})</span>`;
            }).join('')}</div>

            <h4 style="font-size:0.75rem;color:#94a3b8;margin:0.8rem 0 0.3rem">Connected Industries (${connections.length}):</h4>
            ${connections.slice(0, 15).map(e => {
                const other = e.ind1 === nodeId ? e.ind2 : e.ind1;
                return `
                    <div class="connection-item" onclick="focusNode('${other}')">
                        <div class="conn-header">
                            <span class="conn-name">${other}</span>
                            <span class="conn-count">${e.shared} kw</span>
                        </div>
                        <div class="conn-keywords">${e.keywords.join(', ')}</div>
                    </div>
                `;
            }).join('')}
        `;
    }
}

function focusNode(nodeId) {
    if (network) {
        network.focus(nodeId, { scale: 1.5, animation: true });
        network.selectNodes([nodeId]);
        showDetail(nodeId);
    }
}

function switchView() {
    currentView = document.getElementById('viewMode').value;
    applyFilters();
}

function updateThreshold() {
    const val = document.getElementById('threshold').value;
    document.getElementById('threshLabel').textContent = val;
    if (currentView === 'industry') renderIndustryNetwork();
}

function applyFilters() {
    if (currentView === 'industry') renderIndustryNetwork();
    else renderKeywordNetwork();
}

function focusOnIndustry() {
    applyFilters();
}

function updateStats(nodes, edges, thresh) {
    document.getElementById('statNodes').textContent = nodes;
    document.getElementById('statEdges').textContent = edges;
    document.getElementById('statThresh').textContent = thresh;
}

loadData();
</script>
</body>
</html>
