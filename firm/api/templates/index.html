<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>SmartQuery:ê¸°ì—…ë¶„ì„ - NaverReport</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
/* =============================================================================
   WWAI-UI DESIGN TOKENS
   ============================================================================= */

:root {
  --wwai-radius: 0.625rem;
  --wwai-radius-sm: calc(var(--wwai-radius) - 4px);
  --wwai-radius-md: calc(var(--wwai-radius) - 2px);
  --wwai-radius-lg: var(--wwai-radius);

  --wwai-bg-primary: #0f172a;
  --wwai-bg-secondary: #1e293b;
  --wwai-bg-tertiary: #334155;
  --wwai-bg-hover: #475569;

  --wwai-text-primary: #f8fafc;
  --wwai-text-secondary: #cbd5e1;
  --wwai-text-muted: #94a3b8;
  --wwai-text-subtle: #64748b;

  --wwai-border-primary: #475569;
  --wwai-border-secondary: #334155;
  --wwai-border-focus: #3b82f6;

  --wwai-bullish: #10b981;
  --wwai-bullish-light: #34d399;
  --wwai-bullish-bg: rgba(16, 185, 129, 0.2);

  --wwai-bearish: #ef4444;
  --wwai-bearish-light: #f87171;
  --wwai-bearish-bg: rgba(239, 68, 68, 0.2);

  --wwai-neutral: #f59e0b;
  --wwai-neutral-light: #fbbf24;
  --wwai-neutral-bg: rgba(245, 158, 11, 0.2);

  --wwai-accent: #3b82f6;
  --wwai-accent-light: #60a5fa;
  --wwai-accent-dark: #2563eb;
  --wwai-accent-bg: rgba(59, 130, 246, 0.2);

  --wwai-purple: #8b5cf6;
  --wwai-cyan: #06b6d4;
  --wwai-pink: #ec4899;

  --wwai-font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  --wwai-font-korean: 'Noto Sans KR', var(--wwai-font-sans);
  --wwai-font-mono: 'JetBrains Mono', 'Fira Code', monospace;

  --wwai-shadow-glow: 0 0 20px rgba(59, 130, 246, 0.3);
  --wwai-transition-base: 0.2s ease;
}

[data-colorblind="true"] {
  --wwai-bullish: #2563eb;
  --wwai-bullish-light: #3b82f6;
  --wwai-bullish-bg: rgba(37, 99, 235, 0.2);
  --wwai-bearish: #ea580c;
  --wwai-bearish-light: #f97316;
  --wwai-bearish-bg: rgba(234, 88, 12, 0.2);
}

@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    transition-duration: 0.01ms !important;
  }
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--wwai-font-korean);
  background: var(--wwai-bg-primary);
  color: var(--wwai-text-primary);
  min-height: 100vh;
  line-height: 1.6;
}

/* =============================================================================
   LAYOUT
   ============================================================================= */

.container { max-width: 1200px; margin: 0 auto; padding: 1.25rem; }

.header {
  text-align: center;
  margin-bottom: 1.5rem;
  padding: 1.25rem;
  background: linear-gradient(135deg, var(--wwai-bg-secondary) 0%, var(--wwai-bg-tertiary) 100%);
  border-radius: var(--wwai-radius-lg);
  border: 1px solid var(--wwai-border-secondary);
}

.header-title {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
  background: linear-gradient(135deg, var(--wwai-accent-light), var(--api-accent, var(--wwai-accent)));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.header-subtitle { color: var(--wwai-text-secondary); font-size: 0.9rem; }

.header-stats {
  display: flex;
  justify-content: center;
  gap: 2rem;
  margin-top: 1rem;
  flex-wrap: wrap;
}

.wwai-stat { text-align: center; }
.wwai-stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  font-family: var(--wwai-font-mono);
  color: var(--wwai-accent);
}
.wwai-stat-label {
  font-size: 0.75rem;
  color: var(--wwai-text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

/* =============================================================================
   SEARCH SECTION
   ============================================================================= */

.search-section {
  background: var(--wwai-bg-secondary);
  border-radius: var(--wwai-radius-lg);
  padding: 1.5rem;
  margin-bottom: 1.25rem;
  border: 1px solid var(--wwai-border-secondary);
}

.search-row { display: flex; gap: 0.75rem; margin-bottom: 1rem; }

.wwai-input {
  flex: 1;
  padding: 0.875rem 1rem;
  font-size: 1rem;
  font-family: var(--wwai-font-korean);
  background: var(--wwai-bg-primary);
  border: 2px solid var(--wwai-border-secondary);
  border-radius: var(--wwai-radius-md);
  color: var(--wwai-text-primary);
  outline: none;
  transition: border-color var(--wwai-transition-base);
}
.wwai-input:focus { border-color: var(--wwai-border-focus); }
.wwai-input::placeholder { color: var(--wwai-text-subtle); }

.wwai-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.75rem 1.5rem;
  font-size: 1rem;
  font-weight: 600;
  border: none;
  border-radius: var(--wwai-radius-md);
  cursor: pointer;
  transition: all var(--wwai-transition-base);
  background: linear-gradient(135deg, var(--wwai-accent), var(--wwai-accent-dark));
  color: white;
}
.wwai-btn:hover { transform: translateY(-1px); box-shadow: var(--wwai-shadow-glow); }
.wwai-btn:disabled { background: var(--wwai-bg-hover); cursor: not-allowed; transform: none; box-shadow: none; }

.wwai-btn-secondary {
  background: linear-gradient(135deg, var(--wwai-bullish), #059669);
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
}
.wwai-btn-secondary:hover { box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); }

.wwai-summary {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
  border: 1px solid rgba(16, 185, 129, 0.3);
  border-radius: var(--wwai-radius-lg);
  padding: 1.25rem;
  white-space: pre-wrap;
  line-height: 1.7;
}

.wwai-references {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid var(--wwai-border-secondary);
}

.wwai-reference-item {
  display: flex;
  justify-content: space-between;
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--wwai-border-secondary);
  font-size: 0.85rem;
}

.wwai-reference-item:last-child { border-bottom: none; }

.wwai-reference-company { color: var(--wwai-accent-light); font-weight: 500; }
.wwai-reference-issuer { color: var(--wwai-text-muted); }
.wwai-reference-date { color: var(--wwai-text-subtle); }

.options-row { display: flex; gap: 1.25rem; flex-wrap: wrap; align-items: center; }
.option-group { display: flex; align-items: center; gap: 0.5rem; }
.option-group label { color: var(--wwai-text-muted); font-size: 0.85rem; }

.wwai-select {
  padding: 0.5rem 0.75rem;
  font-size: 0.875rem;
  background: var(--wwai-bg-primary);
  border: 1px solid var(--wwai-border-secondary);
  border-radius: var(--wwai-radius-sm);
  color: var(--wwai-text-primary);
}

.examples { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--wwai-border-secondary); }
.examples-title { color: var(--wwai-text-muted); font-size: 0.8rem; margin-bottom: 0.625rem; }
.examples-list { display: flex; gap: 0.5rem; flex-wrap: wrap; }

.example-btn {
  padding: 0.375rem 0.75rem;
  background: var(--wwai-bg-tertiary);
  border: 1px solid var(--wwai-border-secondary);
  border-radius: var(--wwai-radius-sm);
  color: var(--wwai-text-secondary);
  font-size: 0.8rem;
  cursor: pointer;
  transition: all var(--wwai-transition-base);
}
.example-btn:hover { background: var(--api-accent, var(--wwai-accent)); border-color: var(--api-accent, var(--wwai-accent)); color: white; }

/* =============================================================================
   RESULTS SECTION
   ============================================================================= */

.results {
  background: var(--wwai-bg-secondary);
  border-radius: var(--wwai-radius-lg);
  border: 1px solid var(--wwai-border-secondary);
  overflow: hidden;
}

.results-header {
  padding: 1rem 1.25rem;
  background: var(--wwai-bg-tertiary);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 0.75rem;
}

.results-meta { display: flex; gap: 1.25rem; flex-wrap: wrap; }
.meta-item { display: flex; align-items: center; gap: 0.375rem; }
.meta-label { color: var(--wwai-text-muted); font-size: 0.8rem; }
.meta-value { color: var(--wwai-text-primary); font-weight: 500; }

.results-body { padding: 1.25rem; }
.section { margin-bottom: 1.5rem; }
.section:last-child { margin-bottom: 0; }
.section-title {
  color: var(--api-accent, var(--wwai-accent));
  font-size: 0.9rem;
  font-weight: 600;
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.reports-grid { display: grid; gap: 0.75rem; }

/* =============================================================================
   COMPONENTS
   ============================================================================= */

.wwai-badge {
  display: inline-flex;
  align-items: center;
  padding: 0.25rem 0.625rem;
  font-size: 0.75rem;
  font-weight: 600;
  border-radius: var(--wwai-radius-sm);
  text-transform: uppercase;
}
.wwai-badge-bullish { background: var(--wwai-bullish-bg); color: var(--wwai-bullish-light); }
.wwai-badge-bearish { background: var(--wwai-bearish-bg); color: var(--wwai-bearish-light); }
.wwai-badge-neutral { background: var(--wwai-neutral-bg); color: var(--wwai-neutral-light); }
.wwai-badge-accent { background: var(--wwai-accent-bg); color: var(--wwai-accent-light); }

.wwai-intent-badge { padding: 0.25rem 0.625rem; border-radius: 0.75rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
.wwai-intent-lookup { background: var(--wwai-cyan); color: white; }
.wwai-intent-semantic_qa { background: var(--wwai-purple); color: white; }
.wwai-intent-relationship { background: var(--wwai-neutral); color: white; }
.wwai-intent-filter { background: var(--wwai-bullish); color: white; }
.wwai-intent-research { background: var(--wwai-bearish); color: white; }
.wwai-intent-comparison { background: var(--wwai-pink); color: white; }

.wwai-tag {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
  background: var(--wwai-bg-tertiary);
  border-radius: var(--wwai-radius-sm);
  color: var(--wwai-text-secondary);
}

.wwai-answer {
  background: var(--wwai-bg-primary);
  padding: 1rem;
  border-radius: var(--wwai-radius-md);
  border-left: 3px solid var(--api-accent, var(--wwai-accent));
  line-height: 1.7;
  white-space: pre-wrap;
}

.wwai-report-card {
  background: var(--wwai-bg-primary);
  border: 1px solid var(--wwai-border-secondary);
  border-radius: var(--wwai-radius-md);
  padding: 1rem;
  transition: border-color var(--wwai-transition-base);
}
.wwai-report-card:hover { border-color: var(--wwai-border-primary); }
.wwai-report-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.625rem; }
.wwai-report-card-title { font-weight: 600; color: var(--wwai-text-primary); flex: 1; }
.wwai-report-card-title a { color: var(--wwai-accent-light); text-decoration: none; }
.wwai-report-card-title a:hover { text-decoration: underline; }
.wwai-report-card-date { color: var(--wwai-text-muted); font-size: 0.8rem; white-space: nowrap; }
.wwai-report-card-meta { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.625rem; }
.wwai-report-card-summary { color: var(--wwai-text-secondary); font-size: 0.875rem; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

.source-list { display: flex; flex-wrap: wrap; gap: 0.5rem; }
.source-chip { padding: 0.375rem 0.75rem; background: var(--wwai-bg-tertiary); border-radius: var(--wwai-radius-sm); font-size: 0.8rem; color: var(--wwai-text-secondary); }
.source-chip .similarity { color: var(--wwai-bullish); margin-left: 0.375rem; font-family: var(--wwai-font-mono); }

.wwai-routing { display: flex; gap: 1rem; flex-wrap: wrap; padding: 0.75rem; background: var(--wwai-bg-primary); border-radius: var(--wwai-radius-md); }
.wwai-routing-item { display: flex; align-items: center; gap: 0.375rem; font-size: 0.8rem; }
.wwai-routing-db { color: var(--wwai-text-muted); }
.wwai-routing-priority { padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 600; }
.wwai-priority-primary { background: var(--wwai-bullish); color: white; }
.wwai-priority-secondary { background: var(--wwai-accent); color: white; }
.wwai-priority-optional { background: var(--wwai-text-subtle); color: white; }
.wwai-priority-skip { background: var(--wwai-bg-tertiary); color: var(--wwai-text-muted); }

.wwai-spinner { display: inline-block; width: 2rem; height: 2rem; border: 3px solid var(--wwai-border-secondary); border-top-color: var(--wwai-accent); border-radius: 50%; animation: wwai-spin 1s linear infinite; }
@keyframes wwai-spin { to { transform: rotate(360deg); } }

.wwai-loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem; color: var(--wwai-text-muted); gap: 1rem; }
.wwai-error { padding: 1rem; background: var(--wwai-bearish-bg); border-radius: var(--wwai-radius-md); color: var(--wwai-bearish-light); text-align: center; }
.wwai-empty { padding: 3rem; text-align: center; color: var(--wwai-text-muted); }

/* =============================================================================
   ACCESSIBILITY CONTROLS
   ============================================================================= */

.a11y-controls { position: fixed; bottom: 1rem; right: 1rem; display: flex; gap: 0.5rem; }
.a11y-btn {
  padding: 0.5rem;
  background: var(--wwai-bg-tertiary);
  border: 1px solid var(--wwai-border-secondary);
  border-radius: var(--wwai-radius-sm);
  color: var(--wwai-text-muted);
  font-size: 0.75rem;
  cursor: pointer;
  transition: all var(--wwai-transition-base);
}
.a11y-btn:hover, .a11y-btn.active { background: var(--wwai-accent); border-color: var(--wwai-accent); color: white; }

/* =============================================================================
   NAVER THEME PANEL
   ============================================================================= */

.wwai-theme-panel {
  background: var(--wwai-bg-secondary);
  border: 1px solid var(--wwai-border-secondary);
  border-radius: var(--wwai-radius-lg);
  margin-top: 1rem;
  overflow: hidden;
}

.wwai-theme-panel-header {
  padding: 1rem 1.25rem;
  background: linear-gradient(135deg, var(--wwai-purple), #7c3aed);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.wwai-theme-panel-title {
  color: white;
  font-weight: 600;
  font-size: 1rem;
}

.wwai-theme-panel-close {
  background: rgba(255,255,255,0.2);
  border: none;
  border-radius: var(--wwai-radius-sm);
  color: white;
  padding: 0.25rem 0.5rem;
  cursor: pointer;
  font-size: 0.875rem;
}

.wwai-theme-panel-close:hover { background: rgba(255,255,255,0.3); }

.wwai-theme-panel-body { padding: 1.25rem; }

.wwai-theme-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.wwai-theme-chip {
  padding: 0.375rem 0.75rem;
  background: var(--wwai-bg-tertiary);
  border: 1px solid var(--wwai-border-secondary);
  border-radius: var(--wwai-radius-sm);
  color: var(--wwai-text-secondary);
  font-size: 0.8rem;
  cursor: pointer;
  transition: all var(--wwai-transition-base);
}

.wwai-theme-chip:hover {
  background: var(--wwai-purple);
  border-color: var(--wwai-purple);
  color: white;
}

.wwai-theme-chip.active {
  background: var(--wwai-purple);
  border-color: var(--wwai-purple);
  color: white;
}

.wwai-theme-stocks {
  background: var(--wwai-bg-primary);
  border-radius: var(--wwai-radius-md);
  padding: 1rem;
  margin-top: 1rem;
}

.wwai-theme-stocks-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--wwai-border-secondary);
}

.wwai-theme-stocks-title {
  font-weight: 600;
  color: var(--wwai-purple);
}

.wwai-theme-stocks-count {
  font-size: 0.8rem;
  color: var(--wwai-text-muted);
}

.wwai-stock-list { display: grid; gap: 0.5rem; }

.wwai-stock-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.625rem 0.875rem;
  background: var(--wwai-bg-secondary);
  border-radius: var(--wwai-radius-sm);
  border: 1px solid var(--wwai-border-secondary);
}

.wwai-stock-item:hover { border-color: var(--wwai-border-primary); }

.wwai-stock-name {
  font-weight: 500;
  color: var(--wwai-text-primary);
}

.wwai-stock-ticker {
  font-size: 0.75rem;
  color: var(--wwai-text-muted);
  font-family: var(--wwai-font-mono);
  margin-left: 0.5rem;
}

.wwai-stock-scores {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.wwai-score-bar {
  width: 60px;
  height: 8px;
  background: var(--wwai-bg-tertiary);
  border-radius: 4px;
  overflow: hidden;
  display: flex;
}

.wwai-score-bullish { background: var(--wwai-bullish); height: 100%; }
.wwai-score-bearish { background: var(--wwai-bearish); height: 100%; }
.wwai-score-neutral { background: var(--wwai-neutral); height: 100%; }

.wwai-score-value {
  font-size: 0.75rem;
  font-family: var(--wwai-font-mono);
  font-weight: 600;
}

.wwai-score-value.bullish { color: var(--wwai-bullish); }
.wwai-score-value.bearish { color: var(--wwai-bearish); }

.wwai-momentum {
  font-size: 0.7rem;
  padding: 0.125rem 0.375rem;
  border-radius: 0.25rem;
  font-weight: 600;
}

.wwai-momentum.up { background: var(--wwai-bullish-bg); color: var(--wwai-bullish); }
.wwai-momentum.dn { background: var(--wwai-bearish-bg); color: var(--wwai-bearish); }

.wwai-btn-theme {
  background: linear-gradient(135deg, var(--wwai-purple), #7c3aed);
  padding: 0.375rem 0.75rem;
  font-size: 0.8rem;
  border-radius: var(--wwai-radius-sm);
  margin-left: 0.5rem;
}

.wwai-btn-theme:hover { box-shadow: 0 0 15px rgba(139, 92, 246, 0.4); }

/* =============================================================================
   THEME ANALYSIS MINDMAP PANEL
   ============================================================================= */

.wwai-mindmap-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: var(--wwai-bg-primary);
  z-index: 1000;
  display: flex;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.wwai-mindmap-overlay.active {
  opacity: 1;
  visibility: visible;
}

.wwai-mindmap-sidebar {
  width: 320px;
  background: var(--wwai-bg-secondary);
  padding: 1.25rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  border-right: 1px solid var(--wwai-border-secondary);
  overflow-y: auto;
}

.wwai-mindmap-title {
  font-size: 1.2rem;
  font-weight: 700;
  background: linear-gradient(135deg, var(--wwai-accent-light), var(--wwai-accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-align: center;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--wwai-border-secondary);
}

.wwai-mindmap-section {
  background: var(--wwai-bg-primary);
  border: 1px solid var(--wwai-border-secondary);
  border-radius: var(--wwai-radius-md);
  padding: 1rem;
}

.wwai-mindmap-section-title {
  font-size: 0.85rem;
  color: var(--wwai-accent-light);
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 600;
}

.wwai-mindmap-search {
  width: 100%;
  padding: 0.75rem;
  background: var(--wwai-bg-primary);
  border: 2px solid var(--wwai-border-secondary);
  border-radius: var(--wwai-radius-sm);
  color: var(--wwai-text-primary);
  font-size: 0.9rem;
  transition: border-color var(--wwai-transition-base);
}

.wwai-mindmap-search:focus {
  outline: none;
  border-color: var(--wwai-border-focus);
  box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
}

.wwai-mindmap-btn {
  width: 100%;
  padding: 0.625rem;
  background: linear-gradient(135deg, var(--wwai-accent), var(--wwai-accent-dark));
  border: none;
  border-radius: var(--wwai-radius-sm);
  color: white;
  font-weight: 600;
  cursor: pointer;
  margin-top: 0.5rem;
  transition: all var(--wwai-transition-base);
}

.wwai-mindmap-btn:hover { transform: translateY(-1px); box-shadow: var(--wwai-shadow-glow); }

.wwai-sector-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.5rem;
}

.wwai-sector-btn {
  padding: 0.5rem;
  background: var(--wwai-bg-tertiary);
  border: 1px solid var(--wwai-border-secondary);
  border-radius: var(--wwai-radius-sm);
  color: var(--wwai-text-secondary);
  font-size: 0.75rem;
  cursor: pointer;
  transition: all var(--wwai-transition-base);
  text-align: center;
}

.wwai-sector-btn:hover { background: var(--wwai-accent); border-color: var(--wwai-accent); color: white; }
.wwai-sector-btn.active { background: var(--wwai-accent); border-color: var(--wwai-accent); color: white; }

.wwai-mindmap-info {
  background: var(--wwai-bg-primary);
  border-left: 3px solid var(--wwai-accent);
  border-radius: var(--wwai-radius-sm);
  padding: 0.75rem;
  font-size: 0.8rem;
  line-height: 1.6;
  color: var(--wwai-text-secondary);
}

.wwai-mindmap-info .highlight {
  color: var(--wwai-accent-light);
  font-weight: 600;
}

.wwai-mindmap-results {
  max-height: 180px;
  overflow-y: auto;
  font-size: 0.8rem;
}

.wwai-mindmap-result-item {
  padding: 0.5rem 0.625rem;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.wwai-mindmap-result-item:hover { background: var(--wwai-bg-tertiary); }
.wwai-mindmap-result-item.stock { color: var(--wwai-accent-light); }
.wwai-mindmap-result-item.theme { color: var(--wwai-text-primary); }

.wwai-mindmap-controls {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.wwai-ctrl-btn {
  flex: 1;
  min-width: 70px;
  padding: 0.5rem;
  background: var(--wwai-bg-tertiary);
  border: 1px solid var(--wwai-border-secondary);
  border-radius: var(--wwai-radius-sm);
  color: var(--wwai-text-secondary);
  font-size: 0.75rem;
  cursor: pointer;
  transition: all var(--wwai-transition-base);
}

.wwai-ctrl-btn:hover { background: var(--wwai-accent); border-color: var(--wwai-accent); color: white; }

.wwai-mindmap-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  height: 100vh;
  max-height: 100vh;
  overflow: hidden;
}

.wwai-mindmap-header {
  padding: 0.75rem 1.25rem;
  background: var(--wwai-bg-tertiary);
  border-bottom: 1px solid var(--wwai-border-secondary);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.wwai-mindmap-stats {
  display: flex;
  gap: 2rem;
}

.wwai-mindmap-stat {
  text-align: center;
}

.wwai-mindmap-stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  font-family: var(--wwai-font-mono);
}

.wwai-mindmap-stat-value.stock { color: var(--wwai-accent-light); }
.wwai-mindmap-stat-value.theme { color: var(--wwai-accent); }
.wwai-mindmap-stat-value.conn { color: var(--wwai-bullish); }

.wwai-mindmap-stat-label {
  font-size: 0.7rem;
  color: var(--wwai-text-muted);
  text-transform: uppercase;
}

.wwai-mindmap-current {
  color: var(--wwai-text-secondary);
  font-size: 0.9rem;
}

.wwai-mindmap-close {
  background: var(--wwai-bg-tertiary);
  border: 1px solid var(--wwai-border-secondary);
  border-radius: var(--wwai-radius-sm);
  color: var(--wwai-text-secondary);
  padding: 0.5rem 1rem;
  cursor: pointer;
  font-weight: 600;
  transition: all var(--wwai-transition-base);
}

.wwai-mindmap-close:hover { background: var(--wwai-bearish); border-color: var(--wwai-bearish); color: white; }

.wwai-mindmap-canvas {
  flex: 1;
  background: radial-gradient(circle at center, var(--wwai-bg-secondary) 0%, var(--wwai-bg-primary) 100%);
  min-height: 0;
  position: relative;
}

.wwai-mindmap-canvas #mindmap-network {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

/* Tab buttons row */
.wwai-analysis-tabs {
  display: flex;
  gap: 0.75rem;
  padding: 0.75rem 1.25rem;
  background: var(--wwai-bg-secondary);
  border-bottom: 1px solid var(--wwai-border-secondary);
}

.wwai-tab-group {
  display: flex;
  gap: 0.5rem;
  margin-left: auto;
}

.wwai-tab-btn {
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
  font-weight: 600;
  border: none;
  border-radius: var(--wwai-radius-sm);
  cursor: pointer;
  transition: all var(--wwai-transition-base);
}

.wwai-tab-btn-summary {
  background: linear-gradient(135deg, var(--wwai-bullish), #059669);
  color: white;
}

.wwai-tab-btn-summary:hover { box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); }

.wwai-tab-btn-mindmap {
  background: linear-gradient(135deg, var(--wwai-purple), #7c3aed);
  color: white;
}

.wwai-tab-btn-mindmap:hover { box-shadow: 0 0 20px rgba(139, 92, 246, 0.4); }

/* =============================================================================
   RESPONSIVE
   ============================================================================= */

@media (max-width: 640px) {
  .search-row { flex-direction: column; }
  .header-stats { gap: 1rem; }
  .results-header { flex-direction: column; align-items: flex-start; }
  .wwai-stat-value { font-size: 1.25rem; }
  .a11y-controls { bottom: 0.5rem; right: 0.5rem; }
}
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-top" style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 0.5rem;">
                <h1 class="header-title" style="margin: 0;">SmartQuery:ê¸°ì—…ë¶„ì„</h1>
                <div style="display: flex; gap: 0.5rem;">
                    <a href="/analysis" class="demo-link" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: linear-gradient(135deg, #10b981, #3b82f6); color: white; text-decoration: none; border-radius: 6px; font-size: 0.875rem; font-weight: 500; transition: all 0.2s;">
                        ğŸ“Š ì¢…ëª© ë¶„ì„
                    </a>
                    <a href="/industry" class="demo-link" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: linear-gradient(135deg, #f59e0b, #8b5cf6); color: white; text-decoration: none; border-radius: 6px; font-size: 0.875rem; font-weight: 500; transition: all 0.2s;">
                        ì‚°ì—… ë¶„ì„
                    </a>
                    <a href="https://stock-chart-tau.vercel.app/" target="_blank" class="demo-link" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; text-decoration: none; border-radius: 6px; font-size: 0.875rem; font-weight: 500; transition: all 0.2s;">
                        ğŸ“ˆ KRX ì°¨íŠ¸
                    </a>
                </div>
            </div>
            <p class="header-subtitle" id="api-subtitle">NaverReport Multi-Database Query System</p>
            <div class="header-stats" id="header-stats">
                <div class="wwai-stat">
                    <div class="wwai-stat-value" id="stat-reports">-</div>
                    <div class="wwai-stat-label">Reports</div>
                </div>
                <div class="wwai-stat">
                    <div class="wwai-stat-value" id="stat-sources">-</div>
                    <div class="wwai-stat-label">Sources</div>
                </div>
            </div>
        </header>

        <div class="search-section">
            <div class="search-row">
                <input type="text" class="wwai-input" id="query-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
                <button class="wwai-btn" id="search-btn" onclick="executeQuery()">ê²€ìƒ‰</button>
            </div>
            <div class="options-row">
                <div class="option-group">
                    <label>ìµœëŒ€ ë¦¬í¬íŠ¸:</label>
                    <select class="wwai-select" id="max-reports">
                        <option value="3">3</option>
                        <option value="5" selected>5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                    </select>
                </div>
                <div class="option-group" id="option-claims" style="display: none;">
                    <label>ìµœëŒ€ Claims:</label>
                    <select class="wwai-select" id="max-claims">
                        <option value="10">10</option>
                        <option value="30">30</option>
                        <option value="50" selected>50</option>
                    </select>
                </div>
            </div>
            <div class="examples">
                <div class="examples-title">ì˜ˆì‹œ ì§ˆë¬¸:</div>
                <div class="examples-list" id="examples-list"></div>
            </div>
        </div>

        <div class="results" id="results">
            <div class="wwai-empty">ì§ˆë¬¸ì„ ì…ë ¥í•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
        </div>
    </div>

    <div class="a11y-controls">
        <button class="a11y-btn" id="colorblind-toggle" onclick="toggleColorblind()" title="ìƒ‰ë§¹ ëª¨ë“œ">ğŸ‘</button>
    </div>

    <!-- Theme Analysis Mindmap Overlay -->
    <div class="wwai-mindmap-overlay" id="mindmap-overlay">
        <div class="wwai-mindmap-sidebar">
            <div class="wwai-mindmap-title">ğŸ” í…Œë§ˆë¶„ì„ Explorer</div>

            <div class="wwai-mindmap-section">
                <div class="wwai-mindmap-section-title">ğŸ’¬ ì¢…ëª© ê²€ìƒ‰</div>
                <input type="text" class="wwai-mindmap-search" id="mindmap-search" placeholder="ì¢…ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì‚¼ì„±ì „ì)">
                <button class="wwai-mindmap-btn" onclick="mindmapSearch()">ğŸ” ê²€ìƒ‰</button>
            </div>

            <div class="wwai-mindmap-section">
                <div class="wwai-mindmap-section-title">ğŸ·ï¸ í…Œë§ˆ ì¹´í…Œê³ ë¦¬</div>
                <div class="wwai-sector-grid" id="theme-categories">
                    <button class="wwai-sector-btn" style="border-color:#FFD700;" onclick="filterByCategory('ë°˜ë„ì²´')">ë°˜ë„ì²´</button>
                    <button class="wwai-sector-btn" style="border-color:#00BCD4;" onclick="filterByCategory('ë°”ì´ì˜¤')">ë°”ì´ì˜¤/í—¬ìŠ¤</button>
                    <button class="wwai-sector-btn" style="border-color:#2196F3;" onclick="filterByCategory('IT')">IT/ì†Œí”„íŠ¸ì›¨ì–´</button>
                    <button class="wwai-sector-btn" style="border-color:#FF9800;" onclick="filterByCategory('ì—ë„ˆì§€')">ì—ë„ˆì§€/í™”í•™</button>
                    <button class="wwai-sector-btn" style="border-color:#4CAF50;" onclick="filterByCategory('ê¸ˆìœµ')">ê¸ˆìœµ/ë¶€ë™ì‚°</button>
                    <button class="wwai-sector-btn" style="border-color:#E91E63;" onclick="filterByCategory('ì†Œë¹„ì¬')">ì†Œë¹„ì¬/ìœ í†µ</button>
                    <button class="wwai-sector-btn" style="border-color:#9C27B0;" onclick="filterByCategory('ìë™ì°¨')">ìë™ì°¨/ìš´ì†¡</button>
                    <button class="wwai-sector-btn" style="border-color:#607D8B;" onclick="filterByCategory('ê¸°íƒ€')">ê¸°íƒ€</button>
                </div>
            </div>

            <div class="wwai-mindmap-section">
                <div class="wwai-mindmap-section-title">â„¹ï¸ í˜„ì¬ ìƒíƒœ</div>
                <div class="wwai-mindmap-info" id="mindmap-info">
                    ì¢…ëª© ë˜ëŠ” í…Œë§ˆë¥¼ ì„ íƒí•˜ë©´<br>
                    <span class="highlight">ë§ˆì¸ë“œë§µ</span>ì´ í‘œì‹œë©ë‹ˆë‹¤.
                </div>
            </div>

            <div class="wwai-mindmap-section" id="mindmap-results-section" style="display: none;">
                <div class="wwai-mindmap-section-title">ğŸ“‹ ê²€ìƒ‰ ê²°ê³¼</div>
                <div class="wwai-mindmap-results" id="mindmap-results"></div>
            </div>

            <div class="wwai-mindmap-section">
                <div class="wwai-mindmap-section-title">âš™ï¸ ì»¨íŠ¸ë¡¤</div>
                <div class="wwai-mindmap-controls">
                    <button class="wwai-ctrl-btn" onclick="mindmapReset()">ğŸ”„ ì´ˆê¸°í™”</button>
                    <button class="wwai-ctrl-btn" onclick="mindmapFit()">ğŸ” ë§ì¶¤</button>
                    <button class="wwai-ctrl-btn" onclick="mindmapTogglePhysics()">âš¡ ë¬¼ë¦¬</button>
                </div>
            </div>
        </div>

        <div class="wwai-mindmap-main">
            <div class="wwai-mindmap-header">
                <div class="wwai-mindmap-stats">
                    <div class="wwai-mindmap-stat">
                        <div class="wwai-mindmap-stat-value stock" id="mindmap-stock-count">0</div>
                        <div class="wwai-mindmap-stat-label">ì¢…ëª©</div>
                    </div>
                    <div class="wwai-mindmap-stat">
                        <div class="wwai-mindmap-stat-value theme" id="mindmap-theme-count">0</div>
                        <div class="wwai-mindmap-stat-label">í…Œë§ˆ</div>
                    </div>
                    <div class="wwai-mindmap-stat">
                        <div class="wwai-mindmap-stat-value conn" id="mindmap-conn-count">0</div>
                        <div class="wwai-mindmap-stat-label">ì—°ê²°</div>
                    </div>
                </div>
                <div class="wwai-mindmap-current" id="mindmap-current">ì „ì²´ ë³´ê¸°</div>
                <button class="wwai-mindmap-close" onclick="closeMindmap()">âœ• ë‹«ê¸°</button>
            </div>
            <div class="wwai-mindmap-canvas">
                <div id="mindmap-network"></div>
            </div>
        </div>
    </div>

    <script>
const API_CONFIG = {
    firm: { name: 'FirmAnalysis', subtitle: 'ê¸°ì—…ë¶„ì„ ë¦¬í¬íŠ¸ ê²€ìƒ‰ ì‹œìŠ¤í…œ', accent: '#3b82f6', examples: ['ì‚¼ì„±ì „ì HBM ì „ë§', 'AI ë°˜ë„ì²´ ìœ„í—˜ìš”ì¸', 'ì €í‰ê°€ ë°˜ë„ì²´', 'SKí•˜ì´ë‹‰ìŠ¤ íˆ¬ìì˜ê²¬', '2ì°¨ì „ì§€ ê´€ë ¨ì£¼'], showClaims: true },
    strategy: { name: 'InvestmentStrategy', subtitle: 'íˆ¬ìì „ëµ ë¦¬í¬íŠ¸ ê²€ìƒ‰ ì‹œìŠ¤í…œ', accent: '#3b82f6', examples: ['ë¯¸êµ­ ì¦ì‹œ ì „ë§', 'ì±„ê¶Œ ë¹„ì¤‘ ì „ëµ', 'AI í…Œë§ˆ ì „ëµ', 'í‚¤ì›€ì¦ê¶Œ ë¦¬í¬íŠ¸', 'ê¸ˆë¦¬ ì¸ìƒ ì˜í–¥'], showClaims: false },
    industry: { name: 'IndustryAnalysis', subtitle: 'ì‚°ì—…ë¶„ì„ ë¦¬í¬íŠ¸ ê²€ìƒ‰ ì‹œìŠ¤í…œ', accent: '#8b5cf6', examples: ['ë°˜ë„ì²´ ì‚°ì—… ì „ë§', 'ìë™ì°¨ ìˆ˜ìš” ì¦ê°€', 'ì² ê°• ì—…í™© íšŒë³µ', 'ì„ìœ í™”í•™ ì‚¬ì´í´'], showClaims: false },
    econ: { name: 'EconAnalysis', subtitle: 'ê²½ì œë¶„ì„ ë¦¬í¬íŠ¸ ê²€ìƒ‰ ì‹œìŠ¤í…œ', accent: '#10b981', examples: ['ê¸ˆë¦¬ ì¸ìƒ ì „ë§', 'í™˜ìœ¨ ì „ë§', 'ë¬¼ê°€ ìƒìŠ¹', 'ë¯¸êµ­ ê²½ì œ'], showClaims: false }
};

const portMap = { '8080': 'firm', '8001': 'strategy', '8002': 'industry', '8003': 'econ' };
const API_TYPE = portMap[window.location.port] || 'firm';
const CONFIG = API_CONFIG[API_TYPE];

// Store last search results for summarization
let lastSearchResults = null;
let lastQuery = '';

document.addEventListener('DOMContentLoaded', function() {
    document.documentElement.style.setProperty('--api-accent', CONFIG.accent);
    document.getElementById('api-subtitle').textContent = CONFIG.subtitle;
    if (CONFIG.showClaims) document.getElementById('option-claims').style.display = 'flex';

    const examplesList = document.getElementById('examples-list');
    CONFIG.examples.forEach(ex => {
        const btn = document.createElement('button');
        btn.className = 'example-btn';
        btn.textContent = ex;
        btn.onclick = () => setQuery(ex);
        examplesList.appendChild(btn);
    });

    loadStats();
    document.getElementById('query-input').addEventListener('keypress', e => { if (e.key === 'Enter') executeQuery(); });
});

async function loadStats() {
    try {
        const r = await fetch('/stats');
        const d = await r.json();
        if (d.postgresql) document.getElementById('stat-reports').textContent = (d.postgresql.total_reports || 0).toLocaleString();
        if (d.postgresql?.issuers) document.getElementById('stat-sources').textContent = d.postgresql.issuers;
        else if (d.vector?.total_documents) document.getElementById('stat-sources').textContent = d.vector.total_documents.toLocaleString();
    } catch (e) { console.error('Stats error:', e); }
}

function setQuery(q) { document.getElementById('query-input').value = q; executeQuery(); }

async function executeQuery() {
    const query = document.getElementById('query-input').value.trim();
    if (!query) return;

    const maxReports = document.getElementById('max-reports').value;
    const maxClaims = document.getElementById('max-claims')?.value || 50;
    const resultsDiv = document.getElementById('results');
    const searchBtn = document.getElementById('search-btn');

    searchBtn.disabled = true;
    searchBtn.textContent = 'ê²€ìƒ‰ ì¤‘...';
    resultsDiv.innerHTML = '<div class="wwai-loading"><div class="wwai-spinner"></div><div>ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...</div></div>';

    try {
        const body = { question: query, max_reports: parseInt(maxReports) };
        if (CONFIG.showClaims) body.max_claims = parseInt(maxClaims);

        const response = await fetch('/query', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const data = await response.json();

        if (data.success) renderResults(data);
        else resultsDiv.innerHTML = '<div class="results-body"><div class="wwai-error"><strong>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</strong><br>' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜') + '</div></div>';
    } catch (e) {
        resultsDiv.innerHTML = '<div class="results-body"><div class="wwai-error"><strong>ì—°ê²° ì˜¤ë¥˜</strong><br>ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div></div>';
    } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = 'ê²€ìƒ‰';
    }
}

function renderResults(data) {
    // Store for summarization
    lastSearchResults = data;
    lastQuery = document.getElementById('query-input').value.trim();

    const resultsDiv = document.getElementById('results');
    let html = '<div class="results-header"><div class="results-meta">';
    html += '<div class="meta-item"><span class="meta-label">Intent:</span><span class="wwai-intent-badge wwai-intent-' + data.intent + '">' + data.intent + '</span></div>';
    html += '<div class="meta-item"><span class="meta-label">ì†Œìš”ì‹œê°„:</span><span class="meta-value">' + Math.round(data.execution_time_ms) + 'ms</span></div>';
    html += '<div class="meta-item"><span class="meta-label">ë¦¬í¬íŠ¸:</span><span class="meta-value">' + data.reports_count + 'ê±´</span></div>';
    if (data.claims_count) html += '<div class="meta-item"><span class="meta-label">Claims:</span><span class="meta-value">' + data.claims_count + 'ê±´</span></div>';
    if (data.cache_hit) html += '<div class="meta-item"><span class="meta-label">Cache:</span><span class="wwai-badge ' + (data.cache_hit.includes('HIT') ? 'wwai-badge-bullish' : 'wwai-badge-neutral') + '">' + data.cache_hit + '</span></div>';
    html += '</div></div>';

    // Add tab buttons on separate row
    if (data.reports?.length) {
        html += '<div class="wwai-analysis-tabs">';
        html += '<button class="wwai-tab-btn wwai-tab-btn-summary" id="summarize-btn" onclick="generateSummary()">ğŸ”¬ ìš”ì•½ë¶„ì„</button>';
        // Add mindmap button for FirmAnalysis only
        if (API_TYPE === 'firm') {
            html += '<button class="wwai-tab-btn wwai-tab-btn-mindmap" onclick="window.open(\'/theme-graph.html\', \'_blank\')">ğŸ—ºï¸ í…Œë§ˆë¶„ì„</button>';
        }
        html += '</div>';
    }

    html += '<div class="results-body">';

    // Summary section (initially hidden)
    html += '<div id="summary-section" class="section" style="display: none;"></div>';

    if (data.answer) html += '<div class="section"><div class="section-title">ğŸ“Š ë¶„ì„ ê²°ê³¼</div><div class="wwai-answer">' + escapeHtml(data.answer) + '</div></div>';

    if (data.reports?.length) {
        html += '<div class="section"><div class="section-title">ğŸ“‹ ê´€ë ¨ ë¦¬í¬íŠ¸ (' + data.reports.length + 'ê±´)</div><div class="reports-grid">';
        data.reports.forEach(r => { html += renderReportCard(r); });
        html += '</div></div>';
    }

    if (data.graph_insights) html += '<div class="section"><div class="section-title">ğŸ”— Graph ì¸ì‚¬ì´íŠ¸</div><div class="wwai-answer">' + escapeHtml(data.graph_insights) + '</div></div>';

    const related = data.related_themes || data.related_industries || data.related_sectors;
    if (related?.length) {
        const label = data.related_themes ? 'í…Œë§ˆ' : (data.related_industries ? 'ì‚°ì—…' : 'ì„¹í„°');
        html += '<div class="section"><div class="section-title">ğŸ·ï¸ ê´€ë ¨ ' + label + '</div><div class="source-list">';
        related.forEach(item => { html += '<span class="source-chip">' + escapeHtml(typeof item === 'string' ? item : item.name) + '</span>'; });
        html += '</div></div>';
    }

    const sources = data.vector_sources || data.semantic_matches;
    if (sources?.length) {
        html += '<div class="section"><div class="section-title">ğŸ” ìœ ì‚¬ ë¦¬í¬íŠ¸</div><div class="source-list">';
        sources.slice(0, 5).forEach(s => {
            html += '<div class="source-chip">' + escapeHtml(s.company || s.title || s.report_id || 'Unknown');
            if (s.similarity) html += '<span class="similarity">' + (s.similarity * 100).toFixed(1) + '%</span>';
            html += '</div>';
        });
        html += '</div></div>';
    }


    html += '</div>';
    resultsDiv.innerHTML = html;
}

function renderReportCard(r) {
    const date = r.issue_date ? formatDate(r.issue_date) : '-';
    let tags = '';
    if (r.company) {
        tags += '<span class="wwai-tag">ğŸ¢ ' + escapeHtml(r.company) + '</span>';
        // Add theme button for FirmAnalysis only
        if (API_TYPE === 'firm') {
            tags += '<button class="wwai-btn wwai-btn-theme" onclick="showStockThemes(\'' + escapeHtml(r.company).replace(/'/g, "\\'") + '\')">ğŸ·ï¸ í…Œë§ˆ</button>';
        }
    }
    if (r.issuer) tags += '<span class="wwai-tag">ğŸ“ ' + escapeHtml(r.issuer) + '</span>';
    if (r.sector) tags += '<span class="wwai-tag">ğŸ“ ' + escapeHtml(r.sector) + '</span>';
    if (r.industry) tags += '<span class="wwai-tag">ğŸ­ ' + escapeHtml(r.industry) + '</span>';
    if (r.market_outlook) tags += '<span class="wwai-tag wwai-badge-bullish">ğŸ“ˆ ' + r.market_outlook + '</span>';
    if (r.market_regime) tags += '<span class="wwai-tag wwai-badge-neutral">ğŸ¯ ' + r.market_regime + '</span>';
    if (r.cycle_stage) tags += '<span class="wwai-tag">ğŸ“Š ' + r.cycle_stage + '</span>';
    if (r.geography) tags += '<span class="wwai-tag">ğŸŒ ' + r.geography + '</span>';

    const hasUrl = r.pdf_link && r.pdf_link !== 'NaN' && r.pdf_link.startsWith('http');
    const title = hasUrl ? '<a href="' + r.pdf_link + '" target="_blank">' + escapeHtml(r.title || 'ì œëª© ì—†ìŒ') + '</a>' : escapeHtml(r.title || 'ì œëª© ì—†ìŒ');

    let html = '<div class="wwai-report-card"><div class="wwai-report-card-header"><div class="wwai-report-card-title">' + title + '</div><div class="wwai-report-card-date">' + date + '</div></div>';
    if (tags) html += '<div class="wwai-report-card-meta">' + tags + '</div>';
    if (r.summary) html += '<div class="wwai-report-card-summary">' + escapeHtml(r.summary.substring(0, 300)) + (r.summary.length > 300 ? '...' : '') + '</div>';
    html += '</div>';
    return html;
}

async function generateSummary() {
    if (!lastSearchResults || !lastQuery) {
        alert('ë¨¼ì € ê²€ìƒ‰ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.');
        return;
    }

    const btn = document.getElementById('summarize-btn');
    const summarySection = document.getElementById('summary-section');

    btn.disabled = true;
    btn.textContent = 'ìš”ì•½ ìƒì„± ì¤‘...';
    summarySection.innerHTML = '<div class="wwai-loading"><div class="wwai-spinner"></div><div>AIê°€ ë¦¬ì„œì¹˜ ìš”ì•½ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div></div>';
    summarySection.style.display = 'block';

    try {
        const response = await fetch('/summarize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                question: lastQuery,
                reports: lastSearchResults.reports,
                claims: lastSearchResults.claims || [],
                max_reports: 10
            })
        });

        const data = await response.json();

        if (data.success) {
            let html = '<div class="section-title">ğŸ”¬ AI ìš”ì•½ë¶„ì„</div>';
            html += '<div class="wwai-summary">' + escapeHtml(data.summary) + '</div>';

            if (data.references?.length) {
                html += '<div class="wwai-references"><div class="section-title" style="font-size: 0.9rem; margin-bottom: 0.75rem;">ğŸ“š ì°¸ê³  ë¦¬í¬íŠ¸ (' + data.references.length + 'ê±´)</div>';
                data.references.forEach(ref => {
                    // Support different field names: company, sector, strategy, category
                    const label = ref.company || ref.sector || ref.strategy || ref.category || ref.title?.substring(0, 30) || '-';
                    html += '<div class="wwai-reference-item">';
                    html += '<span class="wwai-reference-company">' + escapeHtml(label) + '</span>';
                    html += '<span class="wwai-reference-issuer">' + escapeHtml(ref.issuer) + '</span>';
                    html += '<span class="wwai-reference-date">' + escapeHtml(ref.date) + '</span>';
                    html += '</div>';
                });
                html += '</div>';
            }

            summarySection.innerHTML = html;
        } else {
            summarySection.innerHTML = '<div class="wwai-error"><strong>ìš”ì•½ ìƒì„± ì‹¤íŒ¨</strong><br>' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜') + '</div>';
        }
    } catch (e) {
        summarySection.innerHTML = '<div class="wwai-error"><strong>ì—°ê²° ì˜¤ë¥˜</strong><br>ìš”ì•½ ì„œë¹„ìŠ¤ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ”¬ ìš”ì•½ë¶„ì„';
    }
}

function escapeHtml(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
function formatDate(s) { if (!s) return ''; try { return new Date(s).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' }); } catch (e) { return s; } }
function toggleColorblind() {
    const btn = document.getElementById('colorblind-toggle');
    const active = document.documentElement.getAttribute('data-colorblind') === 'true';
    if (active) { document.documentElement.removeAttribute('data-colorblind'); btn.classList.remove('active'); }
    else { document.documentElement.setAttribute('data-colorblind', 'true'); btn.classList.add('active'); }
}

// ============================================================
// NaverTheme Integration (FirmAnalysis only)
// ============================================================

let currentThemeStock = null;

async function showStockThemes(stockName) {
    console.log('showStockThemes called with:', stockName);
    currentThemeStock = stockName;

    // Remove existing panel if any
    closeThemePanel();

    // Create loading panel - insert after the search section
    const searchSection = document.querySelector('.search-section');
    const panelDiv = document.createElement('div');
    panelDiv.id = 'theme-panel';
    panelDiv.className = 'wwai-theme-panel';
    panelDiv.innerHTML = `
        <div class="wwai-theme-panel-header">
            <span class="wwai-theme-panel-title">ğŸ·ï¸ ${stockName} - NaverTheme</span>
            <button class="wwai-theme-panel-close" onclick="closeThemePanel()">âœ• ë‹«ê¸°</button>
        </div>
        <div class="wwai-theme-panel-body">
            <div class="wwai-loading" style="padding: 2rem;">
                <div class="wwai-spinner"></div>
                <div>í…Œë§ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    `;
    searchSection.insertAdjacentElement('afterend', panelDiv);

    try {
        const response = await fetch('/themes/stock?name=' + encodeURIComponent(stockName));
        const data = await response.json();
        console.log('Theme API response:', data);

        if (data.success && data.themes?.length) {
            renderThemePanel(data);
        } else {
            document.querySelector('#theme-panel .wwai-theme-panel-body').innerHTML =
                '<div class="wwai-empty">í…Œë§ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + (data.error || '') + '</div>';
        }
    } catch (e) {
        console.error('Theme API error:', e);
        document.querySelector('#theme-panel .wwai-theme-panel-body').innerHTML =
            '<div class="wwai-error">í…Œë§ˆ ì„œë¹„ìŠ¤ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + e.message + '</div>';
    }
}

function renderThemePanel(data) {
    const body = document.querySelector('#theme-panel .wwai-theme-panel-body');

    let html = '<div class="wwai-theme-chips">';
    data.themes.forEach((theme) => {
        // Use data attribute instead of inline onclick with quotes
        html += '<span class="wwai-theme-chip" data-theme="' + theme.replace(/"/g, '&quot;') + '">' + escapeHtml(theme) + '</span>';
    });
    html += '</div>';

    // Score display
    if (data.scores) {
        const bullish = (data.scores.bullish * 100).toFixed(1);
        const bearish = (data.scores.bearish * 100).toFixed(1);
        const neutral = (data.scores.neutral * 100).toFixed(1);
        html += '<div style="display: flex; gap: 1rem; align-items: center; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--wwai-border-secondary);">';
        html += '<span style="color: var(--wwai-text-muted); font-size: 0.8rem;">ì‹œê·¸ë„:</span>';
        html += '<span class="wwai-score-value bullish">â–² ' + bullish + '%</span>';
        html += '<span class="wwai-score-value" style="color: var(--wwai-neutral);">â— ' + neutral + '%</span>';
        html += '<span class="wwai-score-value bearish">â–¼ ' + bearish + '%</span>';
        html += '</div>';
    }

    html += '<div id="theme-stocks-container"></div>';

    // Set innerHTML and attach click handlers
    body.innerHTML = html;
    body.querySelectorAll('.wwai-theme-chip').forEach(chip => {
        chip.addEventListener('click', function() {
            loadThemeStocks(this.getAttribute('data-theme'));
        });
    });
}

async function loadThemeStocks(themeName) {
    console.log('loadThemeStocks called with:', themeName);

    // Update active state
    document.querySelectorAll('.wwai-theme-chip').forEach(chip => {
        chip.classList.toggle('active', chip.getAttribute('data-theme') === themeName);
    });

    const container = document.getElementById('theme-stocks-container');
    if (!container) {
        console.error('theme-stocks-container not found');
        return;
    }

    container.innerHTML = '<div class="wwai-theme-stocks"><div class="wwai-loading" style="padding: 1rem;"><div class="wwai-spinner"></div><div>' + escapeHtml(themeName) + ' í…Œë§ˆ ì¢…ëª© ë¡œë”© ì¤‘...</div></div></div>';

    try {
        const url = '/themes/stocks?theme=' + encodeURIComponent(themeName) + '&limit=15';
        console.log('Fetching:', url);
        const response = await fetch(url);
        const data = await response.json();
        console.log('Theme stocks response:', data);

        if (data.success && data.stocks?.length) {
            renderThemeStocks(themeName, data);
        } else {
            console.log('No stocks found or success=false');
            container.innerHTML = '<div class="wwai-empty">í•´ë‹¹ í…Œë§ˆì— ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ' + (data.error || '') + '</div>';
        }
    } catch (e) {
        console.error('loadThemeStocks error:', e);
        container.innerHTML = '<div class="wwai-error">ì¢…ëª© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + e.message + '</div>';
    }
}

function renderThemeStocks(themeName, data) {
    const container = document.getElementById('theme-stocks-container');

    let html = '<div class="wwai-theme-stocks">';
    html += '<div class="wwai-theme-stocks-header">';
    html += '<span class="wwai-theme-stocks-title">ğŸ·ï¸ ' + escapeHtml(themeName) + '</span>';
    html += '<span class="wwai-theme-stocks-count">' + data.stock_count + 'ê°œ ì¢…ëª© ì¤‘ ìƒìœ„ 15ê°œ</span>';
    html += '</div>';
    html += '<div class="wwai-stock-list">';

    data.stocks.forEach(function(stock) {
        const bullish = stock.scores?.bullish || 0;
        const bearish = stock.scores?.bearish || 0;
        const neutral = stock.scores?.neutral || 0;
        const total = bullish + bearish + neutral || 1;

        const bullishPct = (bullish / total * 100).toFixed(0);
        const bearishPct = (bearish / total * 100).toFixed(0);
        const neutralPct = (neutral / total * 100).toFixed(0);

        const scoreValue = stock.total_score?.toFixed(2) || '0.00';
        const scoreClass = stock.total_score > 0 ? 'bullish' : (stock.total_score < 0 ? 'bearish' : '');

        const momentumClass = stock.momentum?.startsWith('up') ? 'up' : 'dn';
        const momentumLabel = stock.momentum?.startsWith('up') ? 'â†‘' : 'â†“';

        html += '<div class="wwai-stock-item">';
        html += '<div>';

        // Make stock name clickable if it's not the current stock
        if (stock.name === currentThemeStock) {
            html += '<span class="wwai-stock-name">' + escapeHtml(stock.name) + '</span>';
        } else {
            html += '<span class="wwai-stock-name wwai-stock-link" data-stock="' + stock.name.replace(/"/g, '&quot;') + '" style="cursor: pointer; color: var(--wwai-accent-light);">' + escapeHtml(stock.name) + '</span>';
        }

        html += '<span class="wwai-stock-ticker">' + escapeHtml(stock.ticker) + '</span>';
        html += '<span class="wwai-momentum ' + momentumClass + '">' + momentumLabel + '</span>';
        html += '</div>';
        html += '<div class="wwai-stock-scores">';
        html += '<div class="wwai-score-bar">';
        html += '<div class="wwai-score-bullish" style="width: ' + bullishPct + '%"></div>';
        html += '<div class="wwai-score-neutral" style="width: ' + neutralPct + '%"></div>';
        html += '<div class="wwai-score-bearish" style="width: ' + bearishPct + '%"></div>';
        html += '</div>';
        html += '<span class="wwai-score-value ' + scoreClass + '">' + scoreValue + '</span>';
        html += '</div>';
        html += '</div>';
    });

    html += '</div></div>';
    container.innerHTML = html;

    // Attach click handlers for stock links
    container.querySelectorAll('.wwai-stock-link').forEach(function(link) {
        link.addEventListener('click', function() {
            showStockThemes(this.getAttribute('data-stock'));
        });
    });
}

function closeThemePanel() {
    const panel = document.getElementById('theme-panel');
    if (panel) panel.remove();
    currentThemeStock = null;
}

// ============================================================
// Theme Analysis Mindmap (vis-network)
// ============================================================

let mindmapNetwork = null;
let mindmapNodes = null;
let mindmapEdges = null;
let mindmapPhysicsEnabled = true;
let mindmapCurrentStock = null;

function openMindmap() {
    const overlay = document.getElementById('mindmap-overlay');
    overlay.classList.add('active');
    document.body.style.overflow = 'hidden';

    let stockToSearch = null;

    // If we have a last searched stock, show its themes
    if (lastQuery) {
        const searchInput = document.getElementById('mindmap-search');
        const match = lastQuery.match(/^([ê°€-í£A-Za-z0-9]+)/);
        if (match) {
            searchInput.value = match[1];
            stockToSearch = match[1];
        }
    }

    // Initialize or reinitialize network after overlay is visible
    setTimeout(() => {
        if (!mindmapNetwork) {
            initMindmapNetwork();
        } else {
            resizeMindmapNetwork();
        }

        // Auto-search if we have a stock name from the last query
        if (stockToSearch) {
            setTimeout(() => {
                loadStockToMindmap(stockToSearch);
            }, 100);
        }
    }, 200);
}

// Handle window resize for mindmap
window.addEventListener('resize', function() {
    if (mindmapNetwork && document.getElementById('mindmap-overlay').classList.contains('active')) {
        resizeMindmapNetwork();
    }
});

function resizeMindmapNetwork() {
    if (!mindmapNetwork) return;

    const container = document.getElementById('mindmap-network');
    const canvas = container.parentElement;
    const main = canvas.parentElement;
    const header = main.querySelector('.wwai-mindmap-header');

    const headerHeight = header ? header.offsetHeight : 80;
    const viewportHeight = window.innerHeight;
    const canvasHeight = viewportHeight - headerHeight;

    canvas.style.height = canvasHeight + 'px';
    canvas.style.position = 'relative';
    container.style.position = 'absolute';
    container.style.top = '0';
    container.style.left = '0';
    container.style.width = '100%';
    container.style.height = '100%';

    const w = canvas.offsetWidth;
    mindmapNetwork.setSize(w + 'px', canvasHeight + 'px');
    mindmapNetwork.redraw();
    mindmapNetwork.fit();
}

function closeMindmap() {
    const overlay = document.getElementById('mindmap-overlay');
    overlay.classList.remove('active');
    document.body.style.overflow = '';
}

function initMindmapNetwork() {
    const container = document.getElementById('mindmap-network');
    const canvas = container.parentElement;
    const main = canvas.parentElement;
    const header = main.querySelector('.wwai-mindmap-header');

    // Calculate and set explicit pixel dimensions
    const headerHeight = header ? header.offsetHeight : 80;
    const viewportHeight = window.innerHeight;
    const canvasHeight = viewportHeight - headerHeight;

    canvas.style.height = canvasHeight + 'px';
    canvas.style.position = 'relative';
    container.style.position = 'absolute';
    container.style.top = '0';
    container.style.left = '0';
    container.style.width = '100%';
    container.style.height = '100%';

    mindmapNodes = new vis.DataSet([]);
    mindmapEdges = new vis.DataSet([]);

    const data = { nodes: mindmapNodes, edges: mindmapEdges };

    const options = {
        nodes: {
            borderWidth: 2,
            shadow: true,
            font: { color: '#fff', size: 14 }
        },
        edges: {
            width: 2,
            color: { color: '#3b82f6', opacity: 0.5 },  // WWAI accent blue
            arrows: { to: { enabled: true, scaleFactor: 0.5 } },
            smooth: { type: 'curvedCW', roundness: 0.15 }
        },
        physics: {
            enabled: true,
            solver: 'forceAtlas2Based',
            forceAtlas2Based: {
                gravitationalConstant: -100,
                springLength: 150,
                springConstant: 0.05,
                avoidOverlap: 0.5
            },
            stabilization: { iterations: 100 }
        },
        interaction: {
            hover: true,
            tooltipDelay: 100,
            dragNodes: true,
            dragView: true,
            zoomView: true
        },
        layout: { improvedLayout: false, randomSeed: 42 }
    };

    mindmapNetwork = new vis.Network(container, data, options);

    // Force resize after creation
    setTimeout(() => {
        const w = canvas.offsetWidth;
        const h = canvas.offsetHeight;
        mindmapNetwork.setSize(w + 'px', h + 'px');
        mindmapNetwork.redraw();
        mindmapNetwork.fit();
    }, 100);

    // Node click handler
    mindmapNetwork.on('click', function(params) {
        if (params.nodes.length > 0) {
            const nodeId = params.nodes[0];
            const node = mindmapNodes.get(nodeId);
            if (node) {
                if (node.type === 'stock') {
                    loadStockToMindmap(node.label.split('\n')[0]);  // Get stock name without emoji
                } else if (node.type === 'theme') {
                    expandThemeStocks(node.themeName || node.label);  // Use original theme name
                }
            }
        }
    });

    // Double-click handler - open stock detail page
    mindmapNetwork.on('doubleClick', function(params) {
        if (params.nodes.length > 0) {
            const nodeId = params.nodes[0];
            const node = mindmapNodes.get(nodeId);
            if (node && node.type === 'stock') {
                const stockName = node.label.split('\n')[0];
                window.open('/stock?name=' + encodeURIComponent(stockName), '_blank');
            }
        }
    });

    // Fit view once physics stabilizes
    mindmapNetwork.on('stabilized', function() {
        mindmapNetwork.fit({ animation: true });
    });
}

async function mindmapSearch() {
    const query = document.getElementById('mindmap-search').value.trim();
    if (!query) return;

    await loadStockToMindmap(query);
}

async function loadStockToMindmap(stockName) {
    mindmapCurrentStock = stockName;
    document.getElementById('mindmap-current').textContent = stockName;
    document.getElementById('mindmap-info').innerHTML = `<span class="highlight">${escapeHtml(stockName)}</span>ì˜ í…Œë§ˆë¥¼ ë¡œë”© ì¤‘...`;

    try {
        const response = await fetch('/themes/stock?name=' + encodeURIComponent(stockName));
        const data = await response.json();

        if (data.success && data.themes?.length) {
            renderStockMindmap(stockName, data);
        } else {
            document.getElementById('mindmap-info').innerHTML = `<span style="color: var(--wwai-bearish);">ì¢…ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>`;
        }
    } catch (e) {
        console.error('Mindmap load error:', e);
        document.getElementById('mindmap-info').innerHTML = `<span style="color: var(--wwai-bearish);">ì˜¤ë¥˜: ${e.message}</span>`;
    }
}

function renderStockMindmap(stockName, data) {
    // Clear existing
    mindmapNodes.clear();
    mindmapEdges.clear();

    const themes = data.themes || [];
    const scores = data.scores || {};

    // Determine buyable status based on bullish vs bearish
    const bullish = scores.bullish || 0;
    const bearish = scores.bearish || 0;
    const isBuyable = bullish > bearish;

    // Center node (stock) - Red if buyable, Blue if not
    const stockBgColor = isBuyable ? '#ef4444' : '#3b82f6';  // Red or Blue
    const stockBorderColor = isBuyable ? '#dc2626' : '#2563eb';
    const stockHighlightBg = isBuyable ? '#f87171' : '#60a5fa';

    mindmapNodes.add({
        id: 'stock_' + stockName,
        label: stockName + (isBuyable ? '\nğŸ”´ ë§¤ìˆ˜' : '\nğŸ”µ ê´€ë§'),
        type: 'stock',
        color: {
            background: stockBgColor,
            border: stockBorderColor,
            highlight: { background: stockHighlightBg, border: stockBgColor }
        },
        shape: 'box',
        font: { size: 16, color: '#fff', bold: true },
        size: 45,
        borderWidth: 3
    });

    // Theme nodes
    themes.forEach((theme, idx) => {
        const nodeId = 'theme_' + theme;

        // Color based on index (blue gradient matching WWAI-UI accent)
        const hue = 210 + (idx * 3) % 30;  // Blue range (210-240)
        const bgColor = `hsl(${hue}, 70%, 45%)`;
        const borderColor = `hsl(${hue}, 70%, 35%)`;

        mindmapNodes.add({
            id: nodeId,
            label: theme,
            themeName: theme,  // Store original theme name for toggle
            type: 'theme',
            color: {
                background: bgColor,
                border: borderColor,
                highlight: { background: `hsl(${hue}, 70%, 55%)`, border: bgColor }
            },
            shape: 'box',
            font: { size: 12, color: '#fff' },
            size: 25
        });

        // Edge from stock to theme
        mindmapEdges.add({
            id: 'edge_' + stockName + '_' + theme,
            from: 'stock_' + stockName,
            to: nodeId,
            color: { color: '#3b82f6', opacity: 0.6 }  // WWAI accent blue
        });
    });

    // Update stats
    document.getElementById('mindmap-stock-count').textContent = '1';
    document.getElementById('mindmap-theme-count').textContent = themes.length;
    document.getElementById('mindmap-conn-count').textContent = themes.length;

    // Update info
    const bullishPct = ((scores.bullish || 0) * 100).toFixed(1);
    const bearishPct = ((scores.bearish || 0) * 100).toFixed(1);
    const neutralPct = ((scores.neutral || 0) * 100).toFixed(1);

    document.getElementById('mindmap-info').innerHTML = `
        <span class="highlight">${escapeHtml(stockName)}</span><br>
        í…Œë§ˆ: ${themes.length}ê°œ<br>
        ì‹œê·¸ë„: <span style="color: var(--wwai-bullish);">â–²${bullishPct}%</span>
        <span style="color: var(--wwai-neutral);">â—${neutralPct}%</span>
        <span style="color: var(--wwai-bearish);">â–¼${bearishPct}%</span><br>
        <a href="/stock?name=${encodeURIComponent(stockName)}" target="_blank" style="color: var(--wwai-accent-light); text-decoration: underline; font-size: 12px;">ğŸ“Š ìƒì„¸ ë³´ê¸° â†’</a>
    `;

    // Show results
    const resultsSection = document.getElementById('mindmap-results-section');
    const resultsList = document.getElementById('mindmap-results');
    resultsSection.style.display = 'block';

    let resultsHtml = '';
    themes.slice(0, 15).forEach(theme => {
        resultsHtml += `<div class="wwai-mindmap-result-item theme" onclick="expandThemeStocks('${escapeHtml(theme).replace(/'/g, "\\'")}')">${escapeHtml(theme)}</div>`;
    });
    resultsList.innerHTML = resultsHtml;

    // Resize and fit view
    setTimeout(() => {
        resizeMindmapNetwork();
    }, 200);
}

// Track expanded themes for toggle functionality
const expandedThemes = new Set();

async function expandThemeStocks(themeName) {
    const themeNodeId = 'theme_' + themeName;

    // If theme is already expanded, collapse it
    if (expandedThemes.has(themeName)) {
        collapseThemeStocks(themeName);
        return;
    }

    document.getElementById('mindmap-info').innerHTML += `<br>ğŸ“Š <span class="highlight">${escapeHtml(themeName)}</span> ì¢…ëª© ë¡œë”©...`;

    try {
        const response = await fetch('/themes/stocks?theme=' + encodeURIComponent(themeName) + '&limit=10');
        const data = await response.json();

        if (data.success && data.stocks?.length) {
            addThemeStocksToMindmap(themeName, data.stocks);
            expandedThemes.add(themeName);

            // Update theme node to show it's expanded
            const themeNode = mindmapNodes.get(themeNodeId);
            if (themeNode) {
                mindmapNodes.update({
                    id: themeNodeId,
                    label: 'ğŸ“‚ ' + themeName,
                    font: { size: 12, color: '#fff', bold: true }
                });
            }
        }
    } catch (e) {
        console.error('Theme stocks error:', e);
    }
}

function collapseThemeStocks(themeName) {
    const themeNodeId = 'theme_' + themeName;

    // Find and remove all stock nodes connected to this theme
    const edgesToRemove = [];
    const nodesToRemove = [];

    // Get all edges as array (vis.DataSet requires .get() method)
    const allEdges = mindmapEdges.get();
    allEdges.forEach(edge => {
        if (edge.from === themeNodeId && edge.id && edge.id.startsWith('edge_' + themeName + '_')) {
            edgesToRemove.push(edge.id);
            // Check if stock node should be removed (only if not connected to other themes)
            const stockNodeId = edge.to;
            const otherConnections = mindmapEdges.get({
                filter: e => e.to === stockNodeId && e.from !== themeNodeId
            });
            if (otherConnections.length === 0) {
                nodesToRemove.push(stockNodeId);
            }
        }
    });

    // Remove edges and nodes
    edgesToRemove.forEach(id => mindmapEdges.remove(id));
    nodesToRemove.forEach(id => mindmapNodes.remove(id));

    // Update counts
    const currentStocks = Math.max(0, parseInt(document.getElementById('mindmap-stock-count').textContent) - nodesToRemove.length);
    const currentConns = Math.max(0, parseInt(document.getElementById('mindmap-conn-count').textContent) - edgesToRemove.length);
    document.getElementById('mindmap-stock-count').textContent = currentStocks;
    document.getElementById('mindmap-conn-count').textContent = currentConns;

    // Update theme node to show it's collapsed
    const themeNode = mindmapNodes.get(themeNodeId);
    if (themeNode) {
        mindmapNodes.update({
            id: themeNodeId,
            label: 'ğŸ“ ' + themeName,
            font: { size: 11, color: '#fff', bold: false }
        });
    }

    // Remove from expanded set
    expandedThemes.delete(themeName);

    document.getElementById('mindmap-info').innerHTML += `<br>ğŸ“ <span class="highlight">${escapeHtml(themeName)}</span> ì ‘í˜`;
}

function addThemeStocksToMindmap(themeName, stocks) {
    const themeNodeId = 'theme_' + themeName;

    // Check if theme node exists
    if (!mindmapNodes.get(themeNodeId)) return;

    let addedCount = 0;

    stocks.forEach((stock, idx) => {
        const stockNodeId = 'stock_' + stock.name;

        // Skip if node already exists
        if (mindmapNodes.get(stockNodeId)) return;

        // Skip if it's the current stock
        if (stock.name === mindmapCurrentStock) return;

        // Get buyable status from buy_or_not DB (API field)
        // If buyable is null/undefined, fall back to score-based logic
        let isBuyable;
        if (stock.buyable !== null && stock.buyable !== undefined) {
            isBuyable = stock.buyable === true || stock.buyable === 'True';
        } else {
            // Fallback: use score if buyable not available
            const score = stock.total_score || 0;
            isBuyable = score > 0;
        }

        let bgColor, borderColor, highlightBg;
        if (isBuyable) {
            // Red for buyable
            bgColor = '#ef4444';
            borderColor = '#dc2626';
            highlightBg = '#f87171';
        } else {
            // Blue for not buyable
            bgColor = '#3b82f6';
            borderColor = '#2563eb';
            highlightBg = '#60a5fa';
        }

        // Format market cap (ì‹œê°€ì´ì•¡) - already in ì¡°ì› (trillion won)
        const marketCap = stock.market_cap || 0;
        let capLabel;
        if (marketCap >= 1) {
            // Show in ì¡° (trillion won)
            capLabel = marketCap.toFixed(1) + 'ì¡°';
        } else if (marketCap >= 0.01) {
            // Show in ì–µ (convert: 1ì¡° = 10000ì–µ)
            capLabel = Math.round(marketCap * 10000).toLocaleString() + 'ì–µ';
        } else {
            capLabel = '-';
        }

        // Node size based on market cap (log scale for better visualization)
        const nodeSize = marketCap > 0 ? 18 + Math.log10(marketCap * 10000 + 1) * 5 : 18;

        mindmapNodes.add({
            id: stockNodeId,
            label: stock.name + '\n' + (isBuyable ? 'ğŸ”´' : 'ğŸ”µ') + ' ' + capLabel,
            type: 'stock',
            color: {
                background: bgColor,
                border: borderColor,
                highlight: { background: highlightBg, border: bgColor }
            },
            shape: 'ellipse',
            font: { size: 10, color: '#fff' },
            size: nodeSize
        });

        // Edge from theme to stock
        mindmapEdges.add({
            id: 'edge_' + themeName + '_' + stock.name,
            from: themeNodeId,
            to: stockNodeId,
            color: { color: '#10b981', opacity: 0.4 },
            width: 1
        });

        addedCount++;
    });

    // Update stats
    const currentStocks = parseInt(document.getElementById('mindmap-stock-count').textContent) + addedCount;
    const currentConns = parseInt(document.getElementById('mindmap-conn-count').textContent) + addedCount;
    document.getElementById('mindmap-stock-count').textContent = currentStocks;
    document.getElementById('mindmap-conn-count').textContent = currentConns;
}

function filterByCategory(category) {
    // Highlight active button
    document.querySelectorAll('.wwai-sector-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.includes(category));
    });

    document.getElementById('mindmap-current').textContent = category + ' ì¹´í…Œê³ ë¦¬';
    document.getElementById('mindmap-info').innerHTML = `<span class="highlight">${category}</span> ê´€ë ¨ í…Œë§ˆë¥¼ ê²€ìƒ‰í•˜ë ¤ë©´<br>ì¢…ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.`;
}

function mindmapReset() {
    if (mindmapNodes) mindmapNodes.clear();
    if (mindmapEdges) mindmapEdges.clear();
    expandedThemes.clear();  // Clear expanded themes tracking

    document.getElementById('mindmap-stock-count').textContent = '0';
    document.getElementById('mindmap-theme-count').textContent = '0';
    document.getElementById('mindmap-conn-count').textContent = '0';
    document.getElementById('mindmap-current').textContent = 'ì „ì²´ ë³´ê¸°';
    document.getElementById('mindmap-info').innerHTML = 'ì¢…ëª© ë˜ëŠ” í…Œë§ˆë¥¼ ì„ íƒí•˜ë©´<br><span class="highlight">ë§ˆì¸ë“œë§µ</span>ì´ í‘œì‹œë©ë‹ˆë‹¤.';
    document.getElementById('mindmap-results-section').style.display = 'none';
    document.getElementById('mindmap-search').value = '';

    document.querySelectorAll('.wwai-sector-btn').forEach(btn => btn.classList.remove('active'));

    mindmapCurrentStock = null;
}

function mindmapFit() {
    if (mindmapNetwork) {
        resizeMindmapNetwork();  // Set proper dimensions first, then fit
    }
}

function mindmapTogglePhysics() {
    mindmapPhysicsEnabled = !mindmapPhysicsEnabled;
    if (mindmapNetwork) {
        mindmapNetwork.setOptions({ physics: { enabled: mindmapPhysicsEnabled } });
    }
}

// Handle escape key to close mindmap
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const overlay = document.getElementById('mindmap-overlay');
        if (overlay && overlay.classList.contains('active')) {
            closeMindmap();
        }
    }
});

// Handle mindmap search on Enter
document.addEventListener('DOMContentLoaded', function() {
    const mindmapSearchInput = document.getElementById('mindmap-search');
    if (mindmapSearchInput) {
        mindmapSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                mindmapSearch();
            }
        });
    }
});
    </script>
</body>
</html>
