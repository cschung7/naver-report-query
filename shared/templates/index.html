<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - SmartQuery</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        {% include 'wwai-tokens.css' %}

        /* =============================================================================
           PAGE LAYOUT
           ============================================================================= */

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.25rem;
        }

        /* =============================================================================
           HEADER
           ============================================================================= */

        .header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 1.25rem;
            background: linear-gradient(135deg, var(--wwai-bg-secondary) 0%, var(--wwai-bg-tertiary) 100%);
            border-radius: var(--wwai-radius-lg);
            border: 1px solid var(--wwai-border-secondary);
        }

        .header-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--wwai-accent-light) 0%, var(--api-accent, var(--wwai-accent)) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-subtitle {
            color: var(--wwai-text-secondary);
            font-size: 0.9rem;
        }

        .header-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        /* =============================================================================
           SEARCH SECTION
           ============================================================================= */

        .search-section {
            background: var(--wwai-bg-secondary);
            border-radius: var(--wwai-radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.25rem;
            border: 1px solid var(--wwai-border-secondary);
        }

        .search-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .search-input {
            flex: 1;
        }

        .options-row {
            display: flex;
            gap: 1.25rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .option-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .option-group label {
            color: var(--wwai-text-muted);
            font-size: 0.85rem;
        }

        .examples {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--wwai-border-secondary);
        }

        .examples-title {
            color: var(--wwai-text-muted);
            font-size: 0.8rem;
            margin-bottom: 0.625rem;
        }

        .examples-list {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .example-btn {
            padding: 0.375rem 0.75rem;
            background: var(--wwai-bg-tertiary);
            border: 1px solid var(--wwai-border-secondary);
            border-radius: var(--wwai-radius-sm);
            color: var(--wwai-text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all var(--wwai-transition-base);
        }

        .example-btn:hover {
            background: var(--api-accent, var(--wwai-accent));
            border-color: var(--api-accent, var(--wwai-accent));
            color: white;
        }

        /* =============================================================================
           RESULTS SECTION
           ============================================================================= */

        .results {
            background: var(--wwai-bg-secondary);
            border-radius: var(--wwai-radius-lg);
            border: 1px solid var(--wwai-border-secondary);
            overflow: hidden;
        }

        .results-header {
            padding: 1rem 1.25rem;
            background: var(--wwai-bg-tertiary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .results-meta {
            display: flex;
            gap: 1.25rem;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .meta-label {
            color: var(--wwai-text-muted);
            font-size: 0.8rem;
        }

        .meta-value {
            color: var(--wwai-text-primary);
            font-weight: 500;
        }

        .results-body {
            padding: 1.25rem;
        }

        .section {
            margin-bottom: 1.5rem;
        }

        .section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            color: var(--api-accent, var(--wwai-accent));
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .reports-grid {
            display: grid;
            gap: 0.75rem;
        }

        /* =============================================================================
           VECTOR/GRAPH SOURCES
           ============================================================================= */

        .source-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .source-chip {
            padding: 0.375rem 0.75rem;
            background: var(--wwai-bg-tertiary);
            border-radius: var(--wwai-radius-sm);
            font-size: 0.8rem;
            color: var(--wwai-text-secondary);
        }

        .source-chip .similarity {
            color: var(--wwai-bullish);
            margin-left: 0.375rem;
            font-family: var(--wwai-font-mono);
        }

        /* =============================================================================
           ACCESSIBILITY CONTROLS
           ============================================================================= */

        .a11y-controls {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .a11y-btn {
            padding: 0.5rem;
            background: var(--wwai-bg-tertiary);
            border: 1px solid var(--wwai-border-secondary);
            border-radius: var(--wwai-radius-sm);
            color: var(--wwai-text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all var(--wwai-transition-base);
        }

        .a11y-btn:hover,
        .a11y-btn.active {
            background: var(--wwai-accent);
            border-color: var(--wwai-accent);
            color: white;
        }

        /* =============================================================================
           RESPONSIVE
           ============================================================================= */

        @media (max-width: 640px) {
            .search-row {
                flex-direction: column;
            }

            .header-stats {
                gap: 1rem;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .a11y-controls {
                bottom: 0.5rem;
                right: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1 class="header-title">SmartQuery</h1>
            <p class="header-subtitle" id="api-subtitle">NaverReport Multi-Database Query System</p>
            <div class="header-stats" id="header-stats">
                <div class="wwai-stat">
                    <div class="wwai-stat-value" id="stat-reports">-</div>
                    <div class="wwai-stat-label">Reports</div>
                </div>
                <div class="wwai-stat">
                    <div class="wwai-stat-value" id="stat-sources">-</div>
                    <div class="wwai-stat-label">Sources</div>
                </div>
                <div class="wwai-stat">
                    <div class="wwai-stat-value" id="stat-db">3</div>
                    <div class="wwai-stat-label">Databases</div>
                </div>
            </div>
        </header>

        <!-- Search Section -->
        <div class="search-section">
            <div class="search-row">
                <input type="text"
                       class="wwai-input search-input"
                       id="query-input"
                       placeholder="ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                       autocomplete="off">
                <button class="wwai-btn wwai-btn-primary" id="search-btn" onclick="executeQuery()">
                    Í≤ÄÏÉâ
                </button>
            </div>

            <div class="options-row">
                <div class="option-group">
                    <label>ÏµúÎåÄ Î¶¨Ìè¨Ìä∏:</label>
                    <select class="wwai-select" id="max-reports">
                        <option value="3">3</option>
                        <option value="5" selected>5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                    </select>
                </div>
                <div class="option-group" id="option-claims" style="display: none;">
                    <label>ÏµúÎåÄ Claims:</label>
                    <select class="wwai-select" id="max-claims">
                        <option value="10">10</option>
                        <option value="30">30</option>
                        <option value="50" selected>50</option>
                    </select>
                </div>
            </div>

            <div class="examples">
                <div class="examples-title">ÏòàÏãú ÏßàÎ¨∏:</div>
                <div class="examples-list" id="examples-list">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results" id="results">
            <div class="wwai-empty">
                ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÍ≥† Í≤ÄÏÉâ Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî
            </div>
        </div>
    </div>

    <!-- Accessibility Controls -->
    <div class="a11y-controls">
        <button class="a11y-btn" id="colorblind-toggle" onclick="toggleColorblind()" title="ÏÉâÎßπ Î™®Îìú">
            üëÅ
        </button>
    </div>

    <script>
        // =============================================================================
        // API CONFIGURATION
        // =============================================================================

        const API_CONFIG = {
            firm: {
                name: 'FirmAnalysis',
                subtitle: 'Í∏∞ÏóÖÎ∂ÑÏÑù Î¶¨Ìè¨Ìä∏ Í≤ÄÏÉâ ÏãúÏä§ÌÖú',
                accent: '#3b82f6',
                examples: [
                    'ÏÇºÏÑ±Ï†ÑÏûê HBM Ï†ÑÎßù',
                    'AI Î∞òÎèÑÏ≤¥ ÏúÑÌóòÏöîÏù∏',
                    'Ï†ÄÌèâÍ∞Ä Î∞òÎèÑÏ≤¥',
                    'SKÌïòÏù¥ÎãâÏä§ Ìà¨ÏûêÏùòÍ≤¨',
                    '2Ï∞®Ï†ÑÏßÄ Í¥ÄÎ†®Ï£º'
                ],
                showClaims: true,
                dbCount: 3
            },
            strategy: {
                name: 'InvestmentStrategy',
                subtitle: 'Ìà¨ÏûêÏ†ÑÎûµ Î¶¨Ìè¨Ìä∏ Í≤ÄÏÉâ ÏãúÏä§ÌÖú',
                accent: '#3b82f6',
                examples: [
                    'ÎØ∏Íµ≠ Ï¶ùÏãú Ï†ÑÎßù',
                    'Ï±ÑÍ∂å ÎπÑÏ§ë Ï†ÑÎûµ',
                    'AI ÌÖåÎßà Ï†ÑÎûµ',
                    'ÌÇ§ÏõÄÏ¶ùÍ∂å Î¶¨Ìè¨Ìä∏',
                    'Í∏àÎ¶¨ Ïù∏ÏÉÅ ÏòÅÌñ•'
                ],
                showClaims: false,
                dbCount: 3
            },
            industry: {
                name: 'IndustryAnalysis',
                subtitle: 'ÏÇ∞ÏóÖÎ∂ÑÏÑù Î¶¨Ìè¨Ìä∏ Í≤ÄÏÉâ ÏãúÏä§ÌÖú',
                accent: '#8b5cf6',
                examples: [
                    'Î∞òÎèÑÏ≤¥ ÏÇ∞ÏóÖ Ï†ÑÎßù',
                    'ÏûêÎèôÏ∞® ÏàòÏöî Ï¶ùÍ∞Ä',
                    'Ï≤†Í∞ï ÏóÖÌô© ÌöåÎ≥µ',
                    'ÏÑùÏú†ÌôîÌïô ÏÇ¨Ïù¥ÌÅ¥'
                ],
                showClaims: false,
                dbCount: 3
            },
            econ: {
                name: 'EconAnalysis',
                subtitle: 'Í≤ΩÏ†úÎ∂ÑÏÑù Î¶¨Ìè¨Ìä∏ Í≤ÄÏÉâ ÏãúÏä§ÌÖú',
                accent: '#10b981',
                examples: [
                    'Í∏àÎ¶¨ Ïù∏ÏÉÅ Ï†ÑÎßù',
                    'ÌôòÏú® Ï†ÑÎßù',
                    'Î¨ºÍ∞Ä ÏÉÅÏäπ',
                    'ÎØ∏Íµ≠ Í≤ΩÏ†ú'
                ],
                showClaims: false,
                dbCount: 2
            }
        };

        // Detect API type from URL or default
        function detectApiType() {
            const port = window.location.port;
            const portMap = {
                '8080': 'firm',
                '8001': 'strategy',
                '8002': 'industry',
                '8003': 'econ'
            };
            return portMap[port] || 'firm';
        }

        const API_TYPE = detectApiType();
        const CONFIG = API_CONFIG[API_TYPE];

        // =============================================================================
        // INITIALIZATION
        // =============================================================================

        document.addEventListener('DOMContentLoaded', function() {
            // Set accent color
            document.documentElement.style.setProperty('--api-accent', CONFIG.accent);

            // Set subtitle
            document.getElementById('api-subtitle').textContent = CONFIG.subtitle;

            // Set DB count
            document.getElementById('stat-db').textContent = CONFIG.dbCount;

            // Show/hide claims option
            if (CONFIG.showClaims) {
                document.getElementById('option-claims').style.display = 'flex';
            }

            // Populate examples
            const examplesList = document.getElementById('examples-list');
            CONFIG.examples.forEach(example => {
                const btn = document.createElement('button');
                btn.className = 'example-btn';
                btn.textContent = example;
                btn.onclick = () => setQuery(example);
                examplesList.appendChild(btn);
            });

            // Load stats
            loadStats();

            // Enter key support
            document.getElementById('query-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') executeQuery();
            });
        });

        // =============================================================================
        // API FUNCTIONS
        // =============================================================================

        async function loadStats() {
            try {
                const response = await fetch('/stats');
                const data = await response.json();

                if (data.postgresql) {
                    document.getElementById('stat-reports').textContent =
                        (data.postgresql.total_reports || 0).toLocaleString();
                }

                if (data.postgresql?.issuers) {
                    document.getElementById('stat-sources').textContent = data.postgresql.issuers;
                } else if (data.vector?.total_documents) {
                    document.getElementById('stat-sources').textContent =
                        data.vector.total_documents.toLocaleString();
                }
            } catch (e) {
                console.error('Stats error:', e);
            }
        }

        function setQuery(query) {
            document.getElementById('query-input').value = query;
            executeQuery();
        }

        async function executeQuery() {
            const query = document.getElementById('query-input').value.trim();
            if (!query) return;

            const maxReports = document.getElementById('max-reports').value;
            const maxClaims = document.getElementById('max-claims')?.value || 50;
            const resultsDiv = document.getElementById('results');
            const searchBtn = document.getElementById('search-btn');

            // Show loading
            searchBtn.disabled = true;
            searchBtn.textContent = 'Í≤ÄÏÉâ Ï§ë...';
            resultsDiv.innerHTML = `
                <div class="wwai-loading">
                    <div class="wwai-spinner"></div>
                    <div>Í≤ÄÏÉâ Ï§ëÏûÖÎãàÎã§...</div>
                </div>
            `;

            try {
                const body = {
                    question: query,
                    max_reports: parseInt(maxReports)
                };

                if (CONFIG.showClaims) {
                    body.max_claims = parseInt(maxClaims);
                }

                const response = await fetch('/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (data.success) {
                    renderResults(data);
                } else {
                    resultsDiv.innerHTML = `
                        <div class="results-body">
                            <div class="wwai-error">
                                <strong>Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</strong><br>
                                ${data.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'}
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                resultsDiv.innerHTML = `
                    <div class="results-body">
                        <div class="wwai-error">
                            <strong>Ïó∞Í≤∞ Ïò§Î•ò</strong><br>
                            ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§.
                        </div>
                    </div>
                `;
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'Í≤ÄÏÉâ';
            }
        }

        function renderResults(data) {
            const resultsDiv = document.getElementById('results');

            let html = `
                <div class="results-header">
                    <div class="results-meta">
                        <div class="meta-item">
                            <span class="meta-label">Intent:</span>
                            <span class="wwai-intent-badge wwai-intent-${data.intent}">${data.intent}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">ÏÜåÏöîÏãúÍ∞Ñ:</span>
                            <span class="meta-value wwai-price">${Math.round(data.execution_time_ms)}ms</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Î¶¨Ìè¨Ìä∏:</span>
                            <span class="meta-value">${data.reports_count}Í±¥</span>
                        </div>
                        ${data.claims_count ? `
                        <div class="meta-item">
                            <span class="meta-label">Claims:</span>
                            <span class="meta-value">${data.claims_count}Í±¥</span>
                        </div>
                        ` : ''}
                        ${data.cache_hit ? `
                        <div class="meta-item">
                            <span class="meta-label">Cache:</span>
                            <span class="wwai-badge ${data.cache_hit.includes('HIT') ? 'wwai-badge-bullish' : 'wwai-badge-neutral'}">${data.cache_hit}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <div class="results-body">
            `;

            // Answer section
            if (data.answer) {
                html += `
                    <div class="section">
                        <div class="section-title">üìä Î∂ÑÏÑù Í≤∞Í≥º</div>
                        <div class="wwai-answer">${escapeHtml(data.answer)}</div>
                    </div>
                `;
            }

            // Reports section
            if (data.reports && data.reports.length > 0) {
                html += `
                    <div class="section">
                        <div class="section-title">üìã Í¥ÄÎ†® Î¶¨Ìè¨Ìä∏ (${data.reports.length}Í±¥)</div>
                        <div class="reports-grid">
                `;

                for (const report of data.reports) {
                    html += renderReportCard(report);
                }

                html += `</div></div>`;
            }

            // Graph insights (if available)
            if (data.graph_insights) {
                html += `
                    <div class="section">
                        <div class="section-title">üîó Graph Ïù∏ÏÇ¨Ïù¥Ìä∏</div>
                        <div class="wwai-answer">${escapeHtml(data.graph_insights)}</div>
                    </div>
                `;
            }

            // Related themes/industries (if available)
            if (data.related_themes?.length || data.related_industries?.length || data.related_sectors?.length) {
                const related = data.related_themes || data.related_industries || data.related_sectors;
                const label = data.related_themes ? 'ÌÖåÎßà' : (data.related_industries ? 'ÏÇ∞ÏóÖ' : 'ÏÑπÌÑ∞');
                html += `
                    <div class="section">
                        <div class="section-title">üè∑Ô∏è Í¥ÄÎ†® ${label}</div>
                        <div class="source-list">
                            ${related.map(item => `<span class="source-chip">${escapeHtml(typeof item === 'string' ? item : item.name)}</span>`).join('')}
                        </div>
                    </div>
                `;
            }

            // Similar reports (if available)
            if (data.vector_sources?.length || data.semantic_matches?.length) {
                const sources = data.vector_sources || data.semantic_matches;
                html += `
                    <div class="section">
                        <div class="section-title">üîç Ïú†ÏÇ¨ Î¶¨Ìè¨Ìä∏</div>
                        <div class="source-list">
                            ${sources.slice(0, 5).map(source => `
                                <div class="source-chip">
                                    ${escapeHtml(source.company || source.title || source.report_id || 'Unknown')}
                                    ${source.similarity ? `<span class="similarity">${(source.similarity * 100).toFixed(1)}%</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }


            html += `</div>`;
            resultsDiv.innerHTML = html;
        }

        function renderReportCard(report) {
            const date = report.issue_date ?
                formatDate(report.issue_date) : '-';

            // Build tags
            let tags = '';
            if (report.company) tags += `<span class="wwai-tag">üè¢ ${escapeHtml(report.company)}</span>`;
            if (report.issuer) tags += `<span class="wwai-tag">üìù ${escapeHtml(report.issuer)}</span>`;
            if (report.sector) tags += `<span class="wwai-tag">üìÅ ${escapeHtml(report.sector)}</span>`;
            if (report.industry) tags += `<span class="wwai-tag">üè≠ ${escapeHtml(report.industry)}</span>`;
            if (report.market_outlook) tags += `<span class="wwai-tag wwai-badge-bullish">üìà ${report.market_outlook}</span>`;
            if (report.market_regime) tags += `<span class="wwai-tag wwai-badge-neutral">üéØ ${report.market_regime}</span>`;
            if (report.cycle_stage) tags += `<span class="wwai-tag">üìä ${report.cycle_stage}</span>`;
            if (report.geography) tags += `<span class="wwai-tag">üåç ${report.geography}</span>`;
            if (report.valuation_regime) tags += `<span class="wwai-tag">üí∞ ${report.valuation_regime}</span>`;
            if (report.growth_regime) tags += `<span class="wwai-tag">üìà ${report.growth_regime}</span>`;

            // Title with optional link
            const hasUrl = report.pdf_link && report.pdf_link !== 'NaN' && report.pdf_link.startsWith('http');
            const titleHtml = hasUrl
                ? `<a href="${report.pdf_link}" target="_blank" style="color: var(--wwai-accent-light); text-decoration: none;">${escapeHtml(report.title || 'Ï†úÎ™© ÏóÜÏùå')}</a>`
                : escapeHtml(report.title || 'Ï†úÎ™© ÏóÜÏùå');

            return `
                <div class="wwai-report-card">
                    <div class="wwai-report-card-header">
                        <div class="wwai-report-card-title">${titleHtml}</div>
                        <div class="wwai-report-card-date">${date}</div>
                    </div>
                    ${tags ? `<div class="wwai-report-card-meta">${tags}</div>` : ''}
                    ${report.summary ? `
                    <div class="wwai-report-card-summary">${escapeHtml(report.summary.substring(0, 300))}${report.summary.length > 300 ? '...' : ''}</div>
                    ` : ''}
                </div>
            `;
        }

        // =============================================================================
        // UTILITIES
        // =============================================================================

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (e) {
                return dateStr;
            }
        }

        // =============================================================================
        // ACCESSIBILITY
        // =============================================================================

        function toggleColorblind() {
            const btn = document.getElementById('colorblind-toggle');
            const isActive = document.documentElement.getAttribute('data-colorblind') === 'true';

            if (isActive) {
                document.documentElement.removeAttribute('data-colorblind');
                btn.classList.remove('active');
            } else {
                document.documentElement.setAttribute('data-colorblind', 'true');
                btn.classList.add('active');
            }
        }
    </script>
</body>
</html>
